# WhisperTextAnalyzer

WhisperTextAnalyzerëŠ” ì‹¤ì‹œê°„ ìŒì„± ìŠ¤íŠ¸ë¦¼ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ê³  ê°ì • ë¶„ì„ì„ ìˆ˜í–‰í•˜ëŠ” End-to-End íŒŒì´í”„ë¼ì¸ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

---

## ğŸ“Œ í”„ë¡œì íŠ¸ ê°œìš”

- í´ë¼ì´ì–¸íŠ¸ ë¸Œë¼ìš°ì €ì—ì„œ **MediaRecorder (Web Audio API ê¸°ë°˜)**ë¡œ ë§ˆì´í¬ ì…ë ¥ì„ ìº¡ì²˜í•˜ì—¬ FastAPI ì„œë²„ë¡œ ì „ì†¡
- **FastAPI WebSocket ì„œë²„**ê°€ ì˜¤ë””ì˜¤ Blob ë°ì´í„°ë¥¼ ìˆ˜ì‹  í›„ Redis audio_queueì— ì €ì¥
- **stt_worker (Celery Worker)**ê°€ audio_queue ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ **OpenAI Whisper ëª¨ë¸**ë¡œ STT (Speech-to-Text) ë³€í™˜
- í…ìŠ¤íŠ¸ë¥¼ Redis text_queueë¡œ ì „ë‹¬
- **analyzer_worker (Celery Worker)**ê°€ text_queueì˜ í…ìŠ¤íŠ¸ë¥¼ **transformers ê¸°ë°˜ ê°ì • ë¶„ì„ ëª¨ë¸**(`distilbert-base-uncased-finetuned-sst-2-english`)ë¡œ ë¶„ì„
- ë¶„ì„ ê²°ê³¼ëŠ” Redis PubSubì˜ result_channelë¡œ publish
- **listener ì„œë¹„ìŠ¤**ê°€ result_channelì„ êµ¬ë…í•˜ì—¬ ê²°ê³¼ ë° í†µê³„ ì •ë³´ë¥¼ íŒŒì¼(`result_listener.log`) + ì½˜ì†”ì— ì¶œë ¥
- ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©ìëŠ” Web UIì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ìì‹ ì˜ ìŒì„± í…ìŠ¤íŠ¸ + ê°ì • ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸ ê°€ëŠ¥

---

## ğŸ› ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## ğŸ› ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
````
Client (ë¸Œë¼ìš°ì €: MediaRecorder â†’ WebSocket) //(loacl testëŠ” recorder ì„œë¹„ìŠ¤)
â†“
FastAPI ì„œë¹„ìŠ¤ (audio_queueë¡œ Redis push)
â†“
Redis (audio_queue â†’ text_queue â†’ PubSub result_channel)
â†“
stt_worker (Celery + Whisper ëª¨ë¸ â†’ text_queueë¡œ push)
â†“
analyzer_worker (Celery + transformers ê°ì • ë¶„ì„ â†’ result_channelë¡œ publish)
â†“
listener (result_channel êµ¬ë… â†’ ì½˜ì†” + íŒŒì¼ë¡œ ì¶œë ¥)
````



---

## âš™ï¸ ì£¼ìš” ê¸°ìˆ  ìŠ¤íƒ

- FastAPI + WebSocket
- MediaRecorder (Web Audio API ê¸°ë°˜)
- Redis (Queue + Pub/Sub)
- Celery (ë¹„ë™ê¸° Worker ê´€ë¦¬)
- Whisper (STT ëª¨ë¸, OpenAI Whisper ê¸°ë°˜)
- Huggingface Transformers (`distilbert-base-uncased-finetuned-sst-2-english` ê°ì • ë¶„ì„)
- Docker + Docker Compose
- 
---

## ğŸ§© ê°œë°œ ì¤‘ ê²ªì—ˆë˜ ë¬¸ì œ ë° í•´ê²° ë°©ë²•

### 1. Python whisper vs openai-whisper í˜¼ìš© ë¬¸ì œ
- ì´ˆê¸°ì—ëŠ” **íŒ¨í‚¤ì§€ whisper**ì™€ **ëª¨ë“ˆ whisper(openai-whisper)**ê°€ í˜¼ìš©ë˜ì–´ ì¶©ëŒ ë°œìƒ
- íŠ¹íˆ **Celery workerì˜ -A ì¸ìì—ì„œ worker íŒŒì¼ëª…ê³¼ whisper íŒ¨í‚¤ì§€ëª…ì´ ì¶©ëŒ** â†’ Celery app load ì‹¤íŒ¨
- **í•µì‹¬ í•´ê²°**
  - worker íŒŒì¼ëª…ì„ `stt_worker.py`, `analyzer_worker.py` ë“±ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ì„¤ì • (ì ˆëŒ€ whisper.py ì“°ì§€ ì•ŠìŒ)
  - Celery ì‹¤í–‰ ì‹œ `celery -A stt_worker:celery_app worker --concurrency=1 --pool=solo`ë¡œ ì •í™•í•˜ê²Œ ëª¨ë“ˆ ì§€ì •
- **ì¶”ê°€ ì•ˆì „ì±…**
  - ì½”ë“œì—ì„œ import í˜¼ë™ ë°©ì§€ë¥¼ ìœ„í•´ `import whisper as openai_whisper`ë¡œ ë³€ê²½

### 2. Windows í™˜ê²½ ê°œë°œ ì‹œ ì œí•œ ì‚¬í•­

- Windows + Docker í™˜ê²½ì—ì„œ **Celery worker ì»¨í…Œì´ë„ˆ ë¹„ì •ìƒ ì¢…ë£Œ, crash** ë°œìƒ
- ì›ì¸: **WindowsëŠ” fork() ë¯¸ì§€ì› â†’ spawn() ë°©ì‹ìœ¼ë¡œ ë¶ˆì•ˆì •**
- ë©€í‹° concurrency ì„¤ì • ì‹œ ë¬¸ì œ ì‹¬í™” â†’ ë°˜ë“œì‹œ `--pool=solo` ì„¤ì • í•„ìš”  
  â†’ `--pool=solo`: **ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤, ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œë§Œ ì‹¤í–‰í•˜ë„ë¡ ê°•ì œ** (Windows í™˜ê²½ì—ì„œ ì•ˆì •ì„± í™•ë³´)
- Dockerì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **í˜¸ìŠ¤íŠ¸ ë§ˆì´í¬ ì‚¬ìš© ë¶ˆê°€**
- í•´ê²°:
  - `record` ì„œë¹„ìŠ¤ë§Œ ë¡œì»¬ Python í”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰
  - ë‚˜ë¨¸ì§€ ì„œë¹„ìŠ¤(`fastapi_service`, `stt_worker`, `redis`)ëŠ” Dockerë¡œ ìš´ì˜
  - ë˜ëŠ” Redisë§Œ Docker, ë‚˜ë¨¸ì§€ëŠ” ë¡œì»¬ë¡œ ì¡°í•© í…ŒìŠ¤íŠ¸

#### âœ… Windows vs Linux â†’ Celery ë©€í‹° í”„ë¡œì„¸ìŠ¤ ì°¨ì´

| ì‹œìŠ¤í…œ | fork() ì§€ì› | Celery ë©€í‹°í”„ë¡œì„¸ìŠ¤ | ê²°ê³¼ |
|-------|-------------|---------------------|------|
| Linux, macOS | âœ… ì§€ì› (`fork()`) | ì •ìƒ ì‘ë™ | ë¬¸ì œ ì—†ìŒ |
| Windows | âŒ ë¯¸ì§€ì› â†’ `spawn()` | ë¶ˆì•ˆì • | worker crash, hang |

#### âœ… fork() vs spawn() ìš”ì•½

| ë°©ì‹ | íŠ¹ì§• | ë¹„ìœ  |
|------|------|------|
| **fork()** | ë¶€ëª¨ ë©”ëª¨ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ë³µì œ â†’ ë¹ ë¥´ê³  ì•ˆì •ì  | ë³µì‚¬ê¸°ë¡œ ì¦‰ì‹œ ë³µì‚¬ |
| **spawn()** | ìƒˆ í”„ë¡œì„¸ìŠ¤ë¡œ ì‹œì‘ â†’ RAM, CPU ì¶”ê°€ ì†Œëª¨ | ìƒˆ ì»´í“¨í„°ì— í”„ë¡œê·¸ë¨ ì¬ì„¤ì¹˜ |

#### âœ… Windowsì—ì„œ spawn()ì˜ ë¬¸ì œ

- `spawn()`ì€ ìƒˆë¡œ Python interpreter + ëª¨ë“  ëª¨ë“ˆ + celery contextë¥¼ ë‹¤ì‹œ ë¡œë“œ â†’ **RAM, CPU ì‚¬ìš©ëŸ‰ ì¦ê°€**
- Docker + Celery + Windows ì¡°í•©ì—ì„œ child processë“¤ì´ redis, broker ì—°ê²° ì‹¤íŒ¨ â†’ **ì£½ìŒ, hang, crash**
- ì‹¤ì§ˆì ìœ¼ë¡œ **Windowsì—ì„œëŠ” Celery ë©€í‹° í”„ë¡œì„¸ìŠ¤ ì‚¬ìš© ë¶ˆê°€**

### 3. ë¦¬ëˆ…ìŠ¤ ì„œë²„ (Azure Linux VM) ë°°í¬ ì‹œ ì–´ë ¤ì›€
- ë¦¬ëˆ…ìŠ¤ëŠ” ìœˆë„ìš°ì™€ ë‹¬ë¼ ê²½ë¡œ, íŒŒì¼ ê¶Œí•œ ë“±ì—ì„œ ì°¨ì´ê°€ ì¡´ì¬
- ì˜ˆìƒì¹˜ ëª»í•œ permission ë¬¸ì œ, Redis ì ‘ì† ë¬¸ì œ ë°œìƒ
- **í•´ê²°**: Azure VM í™˜ê²½ ë§ì¶° Docker ì¬ì…‹íŒ…í•˜ê³  FastAPI ì„œë²„, Redis ì„œë²„ ë”°ë¡œ íŠœë‹

### 4. STT ì„œë¹„ìŠ¤ì˜ ìƒ˜í”Œë§ ì£¼íŒŒìˆ˜ ë¬¸ì œ (ì‹¤ì‹œê°„ FastAPI ì†Œì¼“ í†µì‹ )

Whisper ëª¨ë¸(STT)ì€ **16,000Hz (16kHz)** ìƒ˜í”Œë§ì„ ìš”êµ¬í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ ë¸Œë¼ìš°ì €, ëª¨ë°”ì¼, ë””ë°”ì´ìŠ¤ ë§ˆì´í¬ì˜ ê¸°ë³¸ ìƒ˜í”Œë§ì€ ë³´í†µ **44,100Hz**, **48,000Hz** ë“±ìœ¼ë¡œ ë‹¤ì–‘í•˜ì—¬ **ìƒ˜í”Œë§ ë¶ˆì¼ì¹˜ ë¬¸ì œ**ê°€ ë°œìƒí•©ë‹ˆë‹¤.

FastAPI WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹œ ì„œë²„ì—ì„œ **Whisper ì…ë ¥ìš© PCM ë°ì´í„°**ë¡œ ì „ì†¡í•´ì•¼ í•©ë‹ˆë‹¤.

---

#### âœ” ê¸°ì¡´ ë¬¸ì œì 

ê¸°ì¡´ **MediaRecorder**, **ScriptProcessorNode** ë°©ì‹ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

- AudioContext sampleRate mismatch
- 500ms chunk delay â†’ ì‹¤ì‹œê°„ì„± í•œê³„
- Redisë¡œ ë°ì´í„° ì „ì†¡ ì‹œ ë”œë ˆì´ ë° ëˆ„ë½ ë¬¸ì œ

---

#### âœ” ìµœì¢… ê°œì„ : AudioWorklet ì ìš©

- **AudioWorklet + AudioContext({ sampleRate: 16000 })**ìœ¼ë¡œ ì§ì ‘ **16kHz ìŠ¤íŠ¸ë¦¼ ìƒì„±**
- ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤ì‹œê°„ **PCM Float32 buffer** ìƒì„± â†’ **FastAPI WebSocket**ìœ¼ë¡œ ì¦‰ì‹œ ì „ì†¡
- ì„œë²„ì—ì„œëŠ” ë³„ë„ì˜ downsampling ì—†ì´ ë°”ë¡œ **Redis audio_queue**ë¡œ push ê°€ëŠ¥

---

#### âœ” ê²°ê³¼

- ì§„ì§œ **low-latency ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬** ì™„ì„±
- ë²„í¼ í¬ê¸°ë¥¼ **128~512 frame ìˆ˜ì¤€**ìœ¼ë¡œ ì¡°ì ˆ ê°€ëŠ¥ â†’ **1020ms ë‹¨ìœ„ ì „ì†¡** â†’ ê±°ì˜ í†µí™” ìˆ˜ì¤€ì˜ ì‹¤ì‹œê°„ì„± í™•ë³´
- ë°ì´í„° ì†ì‹¤ ë° ì§€ì—° ë¬¸ì œ ì™„ë²½ í•´ê²°
- Whisper, Celery stt_worker êµ¬ì¡° ë³€ê²½ ì—†ì´ ê·¸ëŒ€ë¡œ í˜¸í™˜

### 5. HTTPS ì¸ì¦ ê´€ë ¨ ì´ìŠˆ (ë¸Œë¼ìš°ì € ë§ˆì´í¬ ê¶Œí•œ)
- ì‹¤ì„œë²„ ë°°í¬ ì‹œ HTTPSê°€ ì—†ìœ¼ë©´ ë¸Œë¼ìš°ì €ê°€ ë§ˆì´í¬ ì ‘ê·¼ ì°¨ë‹¨
- Let's Encryptë¡œ ë¬´ë£Œ SSL ë°œê¸‰ ì‹œë„í–ˆì§€ë§Œ, ê´€ë¦¬ ë³µì¡ + ì‹œê°„ ë¬¸ì œ

### 6. ngrokìœ¼ë¡œ ìš°íšŒ í…ŒìŠ¤íŠ¸
- ê°„ë‹¨íˆ `ngrok http 8000`ì„ ì‚¬ìš©í•´ HTTPS ìš°íšŒ
- **ë‹¨ì **: ngrok ë¬´ë£Œ ë²„ì „ì€ 1ì‹œê°„ë§ˆë‹¤ ì£¼ì†Œê°€ ë°”ë€œ
- **ì¥ì **: ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸, ëª¨ë°”ì¼ ì ‘ì†, ë‹¤ë¥¸ PC ì ‘ì† ë“± ì‰½ê²Œ í•´ê²° ê°€ëŠ¥

### 7. FastAPI WebSocket ë°ì´í„° ìˆ˜ì‹  ë¬¸ì œ

ì´ˆê¸° ë²„ì „ì—ì„œëŠ” FastAPI ì„œë²„ì—ì„œ WebSocketìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ë°ì´í„°ë¥¼ `await websocket.receive()`ë¡œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤. ì´ ë°©ì‹ì€ FastAPIì—ì„œ dict í˜•íƒœë¡œ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ëŠ”ë°, ë¸Œë¼ìš°ì € ì¸¡ì—ì„œ binary ë°ì´í„°ë¥¼ ë³´ë‚¼ ê²½ìš° ë°ì´í„°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¥´ê²Œ ë³€í˜•ë˜ê±°ë‚˜ key issueê°€ ë°œìƒí•˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤. íŠ¹íˆ AudioWorkletì—ì„œ ì „ì†¡í•œ PCM Float32 binary bufferê°€ ì†ì‹¤ë˜ê±°ë‚˜ ì œëŒ€ë¡œ ì „ë‹¬ë˜ì§€ ì•ŠëŠ” í˜„ìƒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ì´ì— ë”°ë¼ WebSocketì—ì„œ binary ë°ì´í„°ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìˆ˜ì‹ í•˜ë ¤ë©´ `await websocket.receive_bytes()`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ í‘œì¤€ì…ë‹ˆë‹¤. ì´ ë°©ì‹ì€ ìˆœìˆ˜ binary ë°ì´í„°ë§Œ ì§ìˆ˜ì‹ í•  ìˆ˜ ìˆì–´ ë°ì´í„° ì†ì‹¤ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

| ê¸°ì¡´ ë°©ì‹ | ê°œì„  ë°©ì‹ |
|-----------|-----------|
| await websocket.receive() â†’ dict ë°˜í™˜ + ë¶ˆì•ˆì • | await websocket.receive_bytes() â†’ bytes ì§ìˆ˜ì‹  |
| ë¸Œë¼ìš°ì €ì—ì„œ binary chunk ë³´ë‚¼ ë•Œ dict key issue ìˆìŒ | binary-only streamì´ë©´ receive_bytesë¡œ ë°”ë¡œ ë°›ëŠ” ê²Œ í‘œì¤€ |

íŠ¹íˆ AudioWorkletì—ì„œ `postMessage(channelData.buffer)` â†’ WebSocket â†’ FastAPIë¡œ ì „ë‹¬ë˜ëŠ” binary ë°ì´í„°ëŠ” ë¬´ì¡°ê±´ `receive_bytes()`ë¡œ ì²˜ë¦¬í•´ì•¼ë§Œ ë°ì´í„° ì†ì‹¤ì´ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### 8. Docker multi-container í™˜ê²½ì—ì„œ Python module import ë¶ˆê°€ ë¬¸ì œ ë° Celery task triggerë¡œ ê°œì„ 

FastAPIì™€ stt_workerë¥¼ ì„œë¡œ ë‹¤ë¥¸ Docker ì»¨í…Œì´ë„ˆë¡œ ë¶„ë¦¬í–ˆì„ ë•Œ, FastAPIì—ì„œ `from stt_worker import transcribe_audio` í˜¸ì¶œ ì‹œ Celery task triggerê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

#### ì›ì¸
- Docker ì»¨í…Œì´ë„ˆëŠ” ì„œë¡œ íŒŒì¼ ì‹œìŠ¤í…œì„ ê³µìœ í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— FastAPI ì»¨í…Œì´ë„ˆì—ì„œëŠ” stt_worker ì»¨í…Œì´ë„ˆì˜ ëª¨ë“ˆì„ importí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
- ì´ˆê¸°ì—ëŠ” stt_worker, analyzer_worker ìì²´ polling êµ¬ì¡° (`while True`ë¡œ Redis queueë¥¼ ë°˜ë³µ í™•ì¸)ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ê°€ë„ë¡ í–ˆì§€ë§Œ, ì»¨í…Œì´ë„ˆ ë¶„ë¦¬ ì´í›„ FastAPIì—ì„œ ì§ì ‘ task í˜¸ì¶œì´ ë¶ˆê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤.
- ë˜í•œ polling êµ¬ì¡°ëŠ” í™•ì¥ì„±, íš¨ìœ¨ì„± ì¸¡ë©´ì—ì„œ í•œê³„ê°€ ìˆì—ˆê³ , Workerê°€ ì²˜ë¦¬ ì¤‘ì¼ ê²½ìš° queue backlogë¡œë§Œ ëŒ€ê¸°í•˜ëŠ” êµ¬ì¡°ì˜€ìŠµë‹ˆë‹¤.

#### ê°œì„  ë° í•´ê²°
- í˜„ì—…ì—ì„œëŠ” ì»¨í…Œì´ë„ˆ ê°„ couplingì„ í”¼í•˜ê¸° ìœ„í•´ ì§ì ‘ Python import ëŒ€ì‹  Celeryì˜ `send_task()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- FastAPIëŠ” task ì´ë¦„ (`"stt_worker.transcribe_audio"`)ê³¼ argument (ì˜ˆ: bytes ë°ì´í„°)ë¥¼ Redis brokerë¡œ ì „ë‹¬í•˜ê³ , Celery workerê°€ Redis queueì—ì„œ í•´ë‹¹ taskë¥¼ subscribeí•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤.
- CeleryëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ëª¨ë“  Python object (`bytes`, `str`, `dict`, `list` ë“±)ë¥¼ ì§ë ¬í™”(=ë°”ì´íŠ¸í™”)í•˜ì—¬ Redis queueì— ì €ì¥í•©ë‹ˆë‹¤.  
ì¦‰, Workerê°€ ë°”ì  ê²½ìš°ì—ë„ taskëŠ” Redis broker queueì— ì•ˆì „í•˜ê²Œ ìŒ“ì—¬ ëŒ€ê¸°í•˜ê²Œ ë©ë‹ˆë‹¤.
- ì´ ë°©ë²•ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ê°„ ì™„ë²½í•œ ë…ë¦½ì„±ì„ ìœ ì§€í•˜ë©°, í™•ì¥ì„±ê³¼ ì•ˆì •ì„±ì´ í–¥ìƒë©ë‹ˆë‹¤.

```python
# âœ… ê°œì„ ëœ ì‹¤ë¬´í˜• Celery task trigger
# FastAPI â†’ Celery broker (Redis)ë¡œ ì§ì ‘ task ì „ë‹¬
# audio_chunkëŠ” bytes ê°ì²´ ê·¸ëŒ€ë¡œ ì „ë‹¬ ê°€ëŠ¥
celery_app.send_task("stt_worker.transcribe_audio", args=[audio_chunk])
```
ì¶”ê°€ ì„¤ëª…
ì´ì „ polling êµ¬ì¡°ì—ì„œëŠ” FastAPI â†’ Redis audio_queue push â†’ Workerê°€ r.rpop()ìœ¼ë¡œ pollingí•˜ì—¬ ê°€ì ¸ê°”ì§€ë§Œ,
ê°œì„  êµ¬ì¡°ì—ì„œëŠ” send_task()ë¡œ ì§ì ‘ Workerì—ê²Œ ì „ë‹¬ â†’ WorkerëŠ” ë°”ë¡œ ì¸ìë¡œ ê°’ì„ ì „ë‹¬ë°›ì•„ ì²˜ë¦¬.
ë”°ë¼ì„œ ê°œì„  í›„ì—ëŠ” Redis audio_queue / text_queueë¥¼ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ìœ¼ë©°, r.lpush(), r.rpop() ì½”ë“œ ë˜í•œ ì‚­ì œë©ë‹ˆë‹¤.
Celeryì˜ send_task()ëŠ” í˜¸ì¶œ ì‹œì ì— Redis broker queueì— taskë¥¼ ë“±ë¡í•˜ê³ ,
Workerê°€ idle ìƒíƒœê°€ ë˜ë©´ queueì—ì„œ taskë¥¼ ê°€ì ¸ì™€ ë°”ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
Redis broker queueëŠ” ì‹¤ì§ˆì ì¸ task buffer ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### 9. Celery í˜¸ì¶œì‹ ì§ë ¬í™” ë° Redis broker ì—­í•  ì •ë¦¬

FastAPI â†’ STT worker, STT worker â†’ Analyzer worker í˜¸ì¶œ ì‹œ Celeryì˜ send_task() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

CeleryëŠ” task í˜¸ì¶œ ì‹œ Python object (ì˜ˆ: str, list ë“±)ë¥¼ ìë™ìœ¼ë¡œ JSON ì§ë ¬í™”í•˜ì—¬ Redis brokerì— ì €ì¥í•©ë‹ˆë‹¤.

RedisëŠ” ë‹¨ìˆœ queue ì—­í• ë§Œ í•˜ë©°, ë°ì´í„° ë‚´ìš©ì„ ë³€í˜•í•˜ê±°ë‚˜ í•´ì„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

âœ… í•µì‹¬ ìš”ì•½  
ì§ë ¬í™”(serialize)ì™€ ë³µì›(deserialize)ì€ Celeryê°€ ì „ë¶€ ì•Œì•„ì„œ ì²˜ë¦¬í•œë‹¤.  
RedisëŠ” ê·¸ì € ì €ì¥ì†Œ ì—­í• ë§Œ í•œë‹¤.  
Worker í•¨ìˆ˜ ì•ˆì—ì„œëŠ” Python object (str, list ë“±)ë¡œ ì´ë¯¸ ë³µì›ëœ ì¸ìë¥¼ ë°›ëŠ”ë‹¤.

WorkerëŠ” Redisì—ì„œ taskë¥¼ ê°€ì ¸ì˜¬ ë•Œ, Celeryê°€ JSONì„ ë””ì½”ë“œí•˜ì—¬ Python objectë¡œ ë³µì›í•œ í›„ task í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

ë”°ë¼ì„œ Worker í•¨ìˆ˜(analyze_text ë“±)ëŠ” í•­ìƒ Python native objectë¥¼ ì¸ìë¡œ ì „ë‹¬ë°›ìŠµë‹ˆë‹¤. (ex. str, list ë“±)

---

#### âœ… ì£¼ìš” ì •ë¦¬

| êµ¬ê°„ | ì—­í•  | íŠ¹ì§• |
|------|------|------|
| FastAPI â†’ Celery Broker | JSON ì§ë ¬í™” | Python object â†’ JSON bytes ë³€í™˜ í›„ Redisì— ì €ì¥ |
| Redis Broker | ë°ì´í„° ì €ì¥ | ì•„ë¬´ê²ƒë„ ë³€í˜•í•˜ì§€ ì•Šê³  ì €ì¥ë§Œ í•¨ |
| Celery Worker â†’ Task | JSON ë””ì½”ë“œ | Redisì—ì„œ ì½ì€ í›„ Python objectë¡œ ë³µì› |

FastAPIì—ì„œ Celeryë¡œ ë„˜ê¸°ëŠ” audio_chunkëŠ” bytesì´ê³ ,  
STTì—ì„œ Analyzerë¡œ ë„˜ê¸°ëŠ” textëŠ” stringì…ë‹ˆë‹¤.

stringì€ JSON ì§ë ¬í™”/ë³µì›ì´ ìì—°ìŠ¤ëŸ½ê¸° ë•Œë¬¸ì— base64 ë³€í™˜ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ analyze_text(text)ì˜ textëŠ” strì´ê¸° ë•Œë¬¸ì— .decode()ë¥¼ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

listener_serviceì²˜ëŸ¼ Redis pubsubì„ ì§ì ‘ ë‹¤ë£¨ëŠ” ê²½ìš°ì—ëŠ” message["data"].decode()ë¥¼ í•´ì¤˜ì•¼ í•˜ì§€ë§Œ,  
Celery taskë¡œ ë°›ì€ ë°ì´í„°ëŠ” ì´ë¯¸ ë³µì›ëœ Python objectë¼ decode ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.


## ğŸ–¼ï¸ ìµœì¢… í”„ë¡œì íŠ¸ ë°°í¬ êµ¬ì¡°
> ê°œë°œ ì¤‘ `record_service`ëŠ” í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì‚¬ìš©í–ˆìœ¼ë‚˜, ìµœì¢… ë°°í¬ì—ì„œëŠ” ì œì™¸

````
WhisperTextAnalyzer/
â”œâ”€â”€ analyzer_worker/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ worker.py
â”œâ”€â”€ fastapi_service/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ service.py
â”œâ”€â”€ listener_service/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ service.py
â”œâ”€â”€ stt_worker/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ worker.py
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ .gitignore
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ README.md
â””â”€â”€ requirements.txt
````


## âœ¨ ìµœì¢… ì†Œê°
- **Python í™˜ê²½ (Windows vs Linux)** ì°¨ì´ë¥¼ ì§ì ‘ ê²½í—˜í•˜ë©° ë°°ì› ìŒ
- ì‹¤ì‹œê°„ WebSocket ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ì˜ ì–´ë ¤ì›€ì„ ì²´í—˜
- Whisper ëª¨ë¸ì´ ê¸°ëŒ€í•˜ëŠ” ì˜¤ë””ì˜¤ í¬ë§·(WAV, 16kHz, mono)ì„ ë§ì¶”ëŠ” ê²Œ ì–¼ë§ˆë‚˜ ê¹Œë‹¤ë¡œìš´ì§€ ì´í•´
- ì‹¤ì„œë¹„ìŠ¤ ë°°í¬ê¹Œì§€ ì§ì ‘ ë‹¤ë£¨ë©´ì„œ **Docker, Redis, Celery, Web Audio API** ì „ì²´ ìŠ¤íƒ ê²½í—˜ ì™„ë£Œ
- ngrokì„ í†µí•œ ê°„í¸ í…ŒìŠ¤íŠ¸ ê¸°ë²•ì„ ì‹¤ë¬´ì—ì„œ ìµí˜

---

# ğŸ“¢ ì£¼ì˜ì‚¬í•­
- ë³¸ í”„ë¡œì íŠ¸ëŠ” í•™ìŠµ ë° ë°ëª¨ìš©ì´ë©°, ì‹¤ì œ ìƒìš© ì„œë¹„ìŠ¤ ë°°í¬ ì‹œ HTTPS/ì¸ì¦/ë³´ì•ˆ ì„¤ì •ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.

````
[User Browser]
 â””â”€ getUserMedia + AudioWorklet (16000Hz PCM buffer)
      â†“
      â†“ WebSocket send (real-time)
[FastAPI Service]
 â””â”€â”€ WebSocket â†’ Redis audio_queueì— push

[stt_worker]
 â””â”€â”€ Redis audio_queue pop â†’ WAV ë³€í™˜ â†’ Whisper STT â†’ Redis text_queue

[analyzer_worker]
 â””â”€â”€ Redis text_queue pop â†’ Sentiment ë¶„ì„ â†’ Redis result_channel publish

[listener_service]
 â””â”€â”€ Redis result_channel listen â†’ ë¡œê·¸/ì½˜ì†” ì¶œë ¥
````



