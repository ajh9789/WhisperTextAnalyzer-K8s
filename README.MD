# WhisperTextAnalyzer

WhisperTextAnalyzerëŠ” ì‹¤ì‹œê°„ ìŒì„± ìŠ¤íŠ¸ë¦¼ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ê³  ê°ì • ë¶„ì„ì„ ìˆ˜í–‰í•˜ëŠ” End-to-End íŒŒì´í”„ë¼ì¸ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
<p>
  <img src="https://img.shields.io/badge/Python-3.10-blue?logo=python&logoColor=white"/>
  <img src="https://img.shields.io/badge/FastAPI-API-009688?logo=fastapi&logoColor=white"/>
  <img src="https://img.shields.io/badge/Redis-Broker-DC382D?logo=redis&logoColor=white"/>
  <img src="https://img.shields.io/badge/Celery-Task%20Queue-37814A?logo=celery&logoColor=white"/>
  <img src="https://img.shields.io/badge/OpenAI-Whisper-3D3D3D?logo=openai&logoColor=white"/>
  <img src="https://img.shields.io/badge/HuggingFace-Transformers-FFD21F?logo=huggingface&logoColor=black"/>
  <img src="https://img.shields.io/badge/sounddevice-Audio-blueviolet"/>
  <img src="https://img.shields.io/badge/Docker-Container-2496ED?logo=docker&logoColor=white"/>
  <img src="https://img.shields.io/badge/Azure-Cloud%20Server-0078D4?logo=microsoftazure&logoColor=white"/>
  <img src="https://img.shields.io/badge/Linux-Server-FCC624?logo=linux&logoColor=black"/>
  <img src="https://img.shields.io/badge/Nginx-Reverse%20Proxy-009639?logo=nginx&logoColor=white"/>
  <img src="https://img.shields.io/badge/NVIDIA-RTX%203070-76B900?logo=nvidia&logoColor=white"/>
  <img src="https://img.shields.io/badge/Windows-10%2B-0078D6?logo=windows&logoColor=white"/>
  <img src="https://img.shields.io/badge/ChatGPT-Assistant-10a37f?logo=openai&logoColor=white"/>
  <img src="https://img.shields.io/badge/PyCharm-Professional-000000?logo=jetbrains&logoColor=white"/>
  <img src="https://img.shields.io/badge/Git-Version%20Control-F05032?logo=git&logoColor=white"/>
</p>

## ğŸ“¸ WhisperTextAnalyzer ì‹œìŠ¤í…œ ì‹¤í–‰ ì˜ˆì‹œ

<p>
  <img src="img.jpg" alt="WhisperTextAnalyzer ì‹œìŠ¤í…œ ì‹¤í–‰ ì˜ˆì‹œ" width="50%"/>
</p>
---

## ğŸ‰ ìµœì¢… ì†Œê°

---
- Python + FastAPI + Redis + Celery ê¸°ë°˜ì˜ STTì™€ ê°ì • ë¶„ì„ ê¸°ëŠ¥ìœ¼ë¡œ ë°°í¬ê¹Œì§€ ê°œë°œ ê²½í—˜
- Celery (ë¹„ë™ê¸° task queue, worker ë¶„ì‚° ì²˜ë¦¬ ê°œë… í•™ìŠµ)ì™€ Redis (queue + pub/sub message broker ì—­í• )ë¥¼ ì‹¤ë¬´ ìˆ˜ì¤€ìœ¼ë¡œ ì´í•´
- Docker ì´í•´ë¥¼ ë†’ì¼ ìˆ˜ ìˆëŠ” (ì»¨í…Œì´ë„ˆ ê¸°ë°˜ ë¶„ì‚° ì‹œìŠ¤í…œ êµ¬ì¶•, Windows + Linux í™˜ê²½ ì°¨ì´, ì´ë¯¸ì§€ ìµœì í™”) ì‹¤ìŠµ ê²½í—˜
- ì‹¤ë¬´ ì‹œìŠ¤í…œ ì„¤ê³„ì— ê°€ê¹ê²Œ í•˜ê¸° ìœ„í•´ ìµœì í™”ì™€ MSA (microservice architecture) ê¸°ë°˜ ìœ ì‚¬í•œ êµ¬ì„±ê¹Œì§€ ì„±ê³µì ìœ¼ë¡œ ì™„ìˆ˜
- WebSocket ì†Œì¼“ í†µì‹  ë° AudioWorkletì„ í†µí•œ ì‹¤ì‹œê°„ ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì „ì†¡ ê¸°ìˆ  í•™ìŠµ ë° êµ¬í˜„
---

---
## ğŸ“Œ í”„ë¡œì íŠ¸ ê°œìš”
- ë¸Œë¼ìš°ì €(Web Audio API + AudioWorklet)ì—ì„œ ë§ˆì´í¬ ì…ë ¥ì„ ìº¡ì²˜í•˜ì—¬ FastAPI ì„œë²„ë¡œ ì „ì†¡
- FastAPI WebSocket ì„œë²„ê°€ ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ Redis Broker(stt_queue)ë¡œ ì „ë‹¬
- stt_workerê°€ OpenAI Whisperë¡œ STT (Speech to Text) ìˆ˜í–‰ í›„ Redis Queue(analyzer_queue)ì— ê²°ê³¼ ì „ë‹¬
- analyzer_workerê°€ Huggingface Transformersë¡œ ê°ì • ë¶„ì„ ìˆ˜í–‰
- listener_serviceê°€ Redis Pub/Sub(result_channel, final_stats)ì„ í†µí•´ ê²°ê³¼ ë° í†µê³„ ë°ì´í„°ë¥¼ ë°œí–‰
- FastAPIê°€ Redis Pub/Sub êµ¬ë… â†’ í´ë¼ì´ì–¸íŠ¸ë¡œ WebSocket ì‹¤ì‹œê°„ ê²°ê³¼ ì—…ë°ì´íŠ¸

---

## ğŸ› ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
Browser (AudioWorklet) 
        â†“
    WebSocket
        â†“
FastAPI â†’ Redis Queue (stt_queue)
        â†“
    stt_worker (Whisper STT)
        â†“
    Redis Queue (analyzer_queue)
        â†“
analyzer_worker (Sentiment Analysis)
        â†“
    Redis Pub/Sub (result_channel, final_stats)
        â†“
listener_service (Publish result + stats â†’ Redis Pub/Sub)
        â†“
    FastAPI (Redis Subscriber â†’ WebSocket push)
        â†“
Browser ì‹¤ì‹œê°„ ê²°ê³¼ ì—…ë°ì´íŠ¸
```

ì°¸ê³ : ê°œë°œ ì¤‘ recorder_serviceë¡œ ë¡œì»¬ í…ŒìŠ¤íŠ¸ (ë°°í¬ì—ëŠ” ë¯¸í¬í•¨)

---
## ğŸš€ ì‹¤ ì„œë¹„ìŠ¤ ë°°í¬ ê²½í—˜

WhisperTextAnalyzer í”„ë¡œì íŠ¸ëŠ” ê°œë°œ â†’ í…ŒìŠ¤íŠ¸ â†’ ì‹¤ë°°í¬ê¹Œì§€ ëª¨ë“  ê³¼ì •ì„ ì§ì ‘ ìˆ˜í–‰í–ˆìŠµë‹ˆë‹¤.

### ğŸ› ï¸ ë°°í¬ ê³¼ì •
- Azure Linux VM ì‹¤ì„œë²„ êµ¬ì¶•
- ê°œë°œ ë‹¨ê³„ì—ì„œ ngrokë¡œ HTTPS ê°œë°œ í…ŒìŠ¤íŠ¸
- ë¬´ë£Œ ë„ë©”ì¸ ì„œë¹„ìŠ¤ [DuckDNS](https://www.duckdns.org) ì‚¬ìš©
- Let's Encryptë¡œ SSL ì¸ì¦ì„œ ë°œê¸‰ ë° ì ìš©
- nginx + Docker + FastAPI ì—°ë™í•˜ì—¬ MSA êµ¬ì¡° êµ¬ì„±
- Celery Worker + Redis Broker + WebSocket ì‹¤ì‹œê°„ ì—°ë™

### ğŸŒ ì‹¤ ì„œë¹„ìŠ¤ ì£¼ì†Œ(í˜„ì¬ëŠ” ë§‰í˜!)
[https://whisperproject.duckdns.org/](https://whisperproject.duckdns.org/)
```
---

## ğŸ“ í´ë” êµ¬ì¡°

```
WhisperTextAnalyzer/
â”œâ”€â”€ analyzer_worker/ # ê°ì • ë¶„ì„ Celery Worker (Huggingface Transformers)
â”‚ â”œâ”€â”€ Dockerfile
â”‚ â”œâ”€â”€ analyzer_worker.py
â”‚ â””â”€â”€ ê¸°íƒ€ ì„¤ì • íŒŒì¼
â”‚
â”œâ”€â”€ fastapi_service/ # FastAPI WebSocket Server + í´ë¼ì´ì–¸íŠ¸ UI + Redis Subscriber
â”‚ â”œâ”€â”€ Dockerfile
â”‚ â”œâ”€â”€ fastapi_service.py
â”‚ â””â”€â”€ ê¸°íƒ€ ì„¤ì • íŒŒì¼
â”‚
â”œâ”€â”€ listener_service/ # Redis Pub/Sub Listener â†’ result_channel, final_stats ì²˜ë¦¬
â”‚ â”œâ”€â”€ Dockerfile
â”‚ â”œâ”€â”€ listener_service.py
â”‚ â””â”€â”€ ê¸°íƒ€ ì„¤ì • íŒŒì¼
â”‚
â”œâ”€â”€ recorder_service/ # ğŸ™ï¸ (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©) ë§ˆì´í¬ ì…ë ¥ â†’ Redis push
â”‚ â”œâ”€â”€ recorder_service.py
â”‚ â””â”€â”€ ê¸°íƒ€ ì„¤ì • íŒŒì¼
â”‚
â”œâ”€â”€ stt_worker/ # Whisper ê¸°ë°˜ STT Celery Worker
â”‚ â”œâ”€â”€ Dockerfile
â”‚ â”œâ”€â”€ stt_worker.py
â”‚ â””â”€â”€ ê¸°íƒ€ ì„¤ì • íŒŒì¼
â”‚
â”œâ”€â”€ docker-compose.yml # ì „ì²´ ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
â”œâ”€â”€ requirements.txt # Python íŒ¨í‚¤ì§€ ì˜ì¡´ì„± ì •ì˜
â”œâ”€â”€ README.md # í”„ë¡œì íŠ¸ ë¬¸ì„œ
â””â”€â”€ ê¸°íƒ€ íŒŒì¼ # .env, .gitignore ë“± ê¸°íƒ€ ì„¤ì • íŒŒì¼
```

---

## ğŸ’» ì„¤ì¹˜ ë° ì‹¤í–‰ ë°©ë²•

ëª¨ë“  ì„œë¹„ìŠ¤ëŠ” Docker Compose ê¸°ë°˜ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.  
ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ìˆœì„œëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”.

```bash
# 1. ë„ì»¤ ì´ë¯¸ì§€ ë¹Œë“œ
docker-compose build

# 2. ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (stt_workerëŠ” 2ê°œë¡œ ìŠ¤ì¼€ì¼ë§)
docker-compose up --scale stt_worker=2 -d
```

```bash
ğŸ’¡ ì°¸ê³ : í˜„ì¬ composeì—ëŠ” ìœˆë„ìš© --concurrency=1 --pool=solo ì˜µì…˜ì´ ì´ë¯¸ ì ìš©ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
ìœˆë„ìš°ì—ì„œ ì‚¬ìš©ì‹œ stt_workerì„ ë³µì‚¬í•´ì„œ stt_worker1ë¡œ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
```
---
### ğŸ“‹ ì£¼ìš” ì»¨í…Œì´ë„ˆ

- redis : Broker ì—­í• 
- stt_worker : Whisper STT (Celery)
- analyzer_worker : Sentiment ë¶„ì„ (Celery)
- listener_service : í†µê³„ ë° ê²°ê³¼ ì¶œë ¥
- fastapi_service : WebSocket ì„œë²„ + í´ë¼ì´ì–¸íŠ¸ UI

---

## ğŸ§© ì£¼ìš” ë¬¸ì œ ë° ê°œì„  ë‚´ì—­

### 1ï¸âƒ£ whisper íŒ¨í‚¤ì§€ ì¶©ëŒ â†’ openai-whisper ëª…í™•íˆ ì‚¬ìš©

```python
import whisper as openai_whisper
```

### 2ï¸âƒ£ Windows Docker + Celery crash â†’ pool=soloë¡œ í•´ê²°

```bash
celery -A stt_worker:celery worker -Q stt_queue --loglevel=info --concurrency=1 --pool=solo
```

### 3ï¸âƒ£ ë¸Œë¼ìš°ì € ìƒ˜í”Œë§ mismatch â†’ AudioWorklet + 16kHz ê³ ì • ê°œì„ 

- AudioContext({ sampleRate: 16000 })
- AudioWorklet â†’ FastAPIë¡œ ì‹¤ì‹œê°„ binary stream ì „ì†¡

### 4ï¸âƒ£ HTTPS í•„ìˆ˜ ì´ìŠˆ â†’ ngrokìœ¼ë¡œ ì„ì‹œ ìš°íšŒ (ê°œë°œ í…ŒìŠ¤íŠ¸)

```bash
ngrok http 8000
```

### 5ï¸âƒ£ FastAPI WebSocket â†’ receive_bytes()ë¡œ ë³€ê²½í•˜ì—¬ binary ì•ˆì • ìˆ˜ì‹ 

```python
await websocket.receive_bytes()
```

### 6ï¸âƒ£ Celery send_task()ë¡œ ì»¨í…Œì´ë„ˆ ê°„ ë…ë¦½ì„± í™•ë³´

```python
celery.send_task("stt_worker.transcribe_audio", args=[audio_chunk], queue="stt_queue")
```

### 7ï¸âƒ£ Redis default queue ë°©ì§€ â†’ queue ëª…ì‹œ

```bash
celery -A analyzer_worker:celery worker -Q analyzer_queue --loglevel=info
```

### 8ï¸âƒ£ connectionë³„ buffer êµ¬ì¡°ë¡œ ë‹¤ì¤‘ ì‚¬ìš©ì ì•ˆì •ì„± í™•ë³´

```python
connected_users[websocket] = {"buffer": bytearray(), "start_time": None}
```

### 9ï¸âƒ£ Silence Threshold ê°œì„  â†’ mobile ëŒ€ë¹„ 0.00001ë¡œ ultra low ì„¤ì •

```javascript
if (energy < 0.00001) return true;
```

### 1ï¸âƒ£0ï¸âƒ£ listener í†µê³„ í¬ë§· ê°œì„ 

```python
f"ê¸ì •: {positive_count}íšŒ {pos_percent:.0f}% / ë¶€ì •: {negative_count}íšŒ {neg_percent:.0f}%"
```

### 1ï¸âƒ£1ï¸âƒ£ FastAPI on_event() ê°œì„  â†’ redis_subscriber task ì•ˆì •í™”

```python
@app.on_event("startup")
async def startup_event():
    asyncio.create_task(redis_subscriber())
```

### 1ï¸âƒ£2ï¸âƒ£ Celery ëª¨ë¸ RAM ì¤‘ë³µ ë¬¸ì œ â†’ global + if model is None íŒ¨í„´ìœ¼ë¡œ í•´ê²°

```python
global model
if model is None:
    model = load_model()
```

### nginx ì„¤ì • ì˜ˆì‹œ

```nginx
server {
    listen 80;
    server_name whisperproject.duckdns.org;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name whisperproject.duckdns.org;
    ssl_certificate /etc/letsencrypt/live/whisperproject.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/whisperproject.duckdns.org/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:8000;
    }

    location /ws {
        proxy_pass http://127.0.0.1:8000/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}
```

---

## âœ… ìµœì¢… ê°œì„  ë²„ì „ í•µì‹¬ ìš”ì•½

| ê°œì„  í•­ëª© | ìƒíƒœ |
|-----------|------|
| Whisper ëª¨ë¸ STT | âœ… ì™„ì„± |
| Sentiment ë¶„ì„ | âœ… ì™„ì„± |
| Listener í†µê³„ | âœ… ê°œì„  ì™„ë£Œ |
| FastAPI WebSocket ì„œë²„ | âœ… ê°œì„  ì™„ë£Œ |
| ì‹¤ì‹œê°„ AudioWorklet | âœ… ì ìš© ì™„ë£Œ |
| Multi User Buffer | âœ… ì ìš© ì™„ë£Œ |
| Mobile Threshold ìµœì í™” | âœ… ì ìš© ì™„ë£Œ |

## ğŸ“¢ ì£¼ì˜ì‚¬í•­

ë³¸ í”„ë¡œì íŠ¸ëŠ” í•™ìŠµ ë° ë°ëª¨ìš©ì´ë©°, ì‹¤ì œ ì„œë¹„ìŠ¤ ë°°í¬ ì‹œ HTTPS ë° ë³´ì•ˆ ì„¤ì •ì„ ë°˜ë“œì‹œ ê°•í™”í•˜ì„¸ìš”.
