# WhisperTextAnalyzer

WhisperTextAnalyzerëŠ” ì‹¤ì‹œê°„ ìŒì„± ìŠ¤íŠ¸ë¦¼ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ê³  ê°ì • ë¶„ì„ì„ ìˆ˜í–‰í•˜ëŠ” End-to-End íŒŒì´í”„ë¼ì¸ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

---

## ğŸ“Œ í”„ë¡œì íŠ¸ ê°œìš”

- ë¸Œë¼ìš°ì €(Web Audio API + AudioWorklet)ì—ì„œ ë§ˆì´í¬ ì…ë ¥ì„ ìº¡ì²˜í•˜ì—¬ FastAPI ì„œë²„ë¡œ ì „ì†¡
- FastAPI WebSocket ì„œë²„ê°€ ì˜¤ë””ì˜¤ ë°ì´í„°ë¥¼ Redis brokerë¡œ ì „ë‹¬
- stt_workerê°€ OpenAI Whisperë¡œ STT (Speech to Text) ìˆ˜í–‰
- analyzer_workerê°€ Huggingface transformersë¡œ ê°ì • ë¶„ì„
- listener_serviceê°€ ê²°ê³¼ë¥¼ í†µê³„ + ì½˜ì†” + íŒŒì¼ë¡œ ì¶œë ¥

---

## ğŸ› ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
Browser (AudioWorklet) â†’ WebSocket
â†“
FastAPI â†’ Redis (Broker)
â†“
stt_worker (Whisper STT)
â†“
analyzer_worker (Sentiment Analysis)
â†“
listener_service (Publish result + stats)
```

ì°¸ê³ : ê°œë°œ ì¤‘ recorder_serviceë¡œ ë¡œì»¬ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ (ë°°í¬ì—ëŠ” ë¯¸í¬í•¨)

---

## ğŸ“ í´ë” êµ¬ì¡°

```
WhisperTextAnalyzer/
â”œâ”€â”€ analyzer_worker/
â”œâ”€â”€ fastapi_service/
â”œâ”€â”€ listener_service/
â”œâ”€â”€ recorder_service/ (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©)
â”œâ”€â”€ stt_worker/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ requirements.txt
â””â”€â”€ ê¸°íƒ€ íŒŒì¼
```

---

## ğŸ’» ì„¤ì¹˜ ë° ì‹¤í–‰ ë°©ë²•

```bash
# Docker ê¸°ë°˜ ì‹¤í–‰
$ docker-compose up --scale stt_worker=2 -d

# Windows: pool=solo í•„ìˆ˜ â†’ ì´ë¯¸ ì ìš©ë¨
```

### ğŸ“‹ ì£¼ìš” ì»¨í…Œì´ë„ˆ

- redis : Broker ì—­í• 
- stt_worker : Whisper STT (Celery)
- analyzer_worker : Sentiment ë¶„ì„ (Celery)
- listener_service : í†µê³„ ë° ê²°ê³¼ ì¶œë ¥
- fastapi_service : WebSocket ì„œë²„ + í´ë¼ì´ì–¸íŠ¸ UI

---

## ğŸ§© ì£¼ìš” ë¬¸ì œ ë° ê°œì„  ë‚´ì—­

### 1ï¸âƒ£ whisper íŒ¨í‚¤ì§€ ì¶©ëŒ â†’ openai-whisper ëª…í™•íˆ ì‚¬ìš©

```python
import whisper as openai_whisper
```

### 2ï¸âƒ£ Windows Docker + Celery crash â†’ pool=soloë¡œ í•´ê²°

```bash
celery -A stt_worker:celery worker -Q stt_queue --loglevel=info --concurrency=1 --pool=solo
```

### 3ï¸âƒ£ ë¸Œë¼ìš°ì € ìƒ˜í”Œë§ mismatch â†’ AudioWorklet + 16kHz ê³ ì • ê°œì„ 

- AudioContext({ sampleRate: 16000 })
- AudioWorklet â†’ FastAPIë¡œ ì‹¤ì‹œê°„ binary stream ì „ì†¡

### 4ï¸âƒ£ HTTPS í•„ìˆ˜ ì´ìŠˆ â†’ ngrokìœ¼ë¡œ ì„ì‹œ ìš°íšŒ (ê°œë°œ í…ŒìŠ¤íŠ¸)

```bash
ngrok http 8000
```

### 5ï¸âƒ£ FastAPI WebSocket â†’ receive_bytes()ë¡œ ë³€ê²½í•˜ì—¬ binary ì•ˆì • ìˆ˜ì‹ 

```python
await websocket.receive_bytes()
```

### 6ï¸âƒ£ Celery send_task()ë¡œ ì»¨í…Œì´ë„ˆ ê°„ ë…ë¦½ì„± í™•ë³´

```python
celery.send_task("stt_worker.transcribe_audio", args=[audio_chunk], queue="stt_queue")
```

### 7ï¸âƒ£ Redis default queue ë°©ì§€ â†’ queue ëª…ì‹œ

```bash
celery -A analyzer_worker:celery worker -Q analyzer_queue --loglevel=info
```

### 8ï¸âƒ£ connectionë³„ buffer êµ¬ì¡°ë¡œ ë‹¤ì¤‘ ì‚¬ìš©ì ì•ˆì •ì„± í™•ë³´

```python
connected_users[websocket] = {"buffer": bytearray(), "start_time": None}
```

### 9ï¸âƒ£ Silence Threshold ê°œì„  â†’ mobile ëŒ€ë¹„ 0.00001ë¡œ ultra low ì„¤ì •

```javascript
if (energy < 0.00001) return true;
```

### 1ï¸âƒ£0ï¸âƒ£ listener í†µê³„ í¬ë§· ê°œì„ 

```python
f"ê¸ì •: {positive_count}íšŒ {pos_percent:.0f}% / ë¶€ì •: {negative_count}íšŒ {neg_percent:.0f}%"
```

### 1ï¸âƒ£1ï¸âƒ£ FastAPI on_event() ê°œì„  â†’ redis_subscriber task ì•ˆì •í™”

```python
@app.on_event("startup")
async def startup_event():
    asyncio.create_task(redis_subscriber())
```

### 1ï¸âƒ£2ï¸âƒ£ Celery ëª¨ë¸ RAM ì¤‘ë³µ ë¬¸ì œ â†’ global + if model is None íŒ¨í„´ìœ¼ë¡œ í•´ê²°

```python
global model
if model is None:
    model = load_model()
```

---

## ğŸš€ ì‹¤ ì„œë¹„ìŠ¤ ë°°í¬ ì˜ˆì‹œ

### nginx + Docker + FastAPI

```
Client (Browser)
â†“
nginx â†’ FastAPI (WebSocket + STT)
â†“
Redis (Broker)
â†“
Celery Worker (STT + Analyzer)
â†“
Listener + Dashboard
```

### nginx ì„¤ì • ì˜ˆì‹œ

```nginx
server {
    listen 80;
    server_name whisperproject.duckdns.org;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name whisperproject.duckdns.org;
    ssl_certificate /etc/letsencrypt/live/whisperproject.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/whisperproject.duckdns.org/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:8000;
    }

    location /ws {
        proxy_pass http://127.0.0.1:8000/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}
```

---

## âœ… ìµœì¢… ê°œì„  ë²„ì „ í•µì‹¬ ìš”ì•½

| ê°œì„  í•­ëª© | ìƒíƒœ |
|-----------|------|
| Whisper ëª¨ë¸ STT | âœ… ì™„ì„± |
| Sentiment ë¶„ì„ | âœ… ì™„ì„± |
| Listener í†µê³„ | âœ… ê°œì„  ì™„ë£Œ |
| FastAPI WebSocket ì„œë²„ | âœ… ê°œì„  ì™„ë£Œ |
| ì‹¤ì‹œê°„ AudioWorklet | âœ… ì ìš© ì™„ë£Œ |
| Multi User Buffer | âœ… ì ìš© ì™„ë£Œ |
| Mobile Threshold ìµœì í™” | âœ… ì ìš© ì™„ë£Œ |

---

## ğŸ‰ ìµœì¢… ì†Œê°

- Python + FastAPI + Redis + Celery + Whisper ì‹¤ì„œë¹„ìŠ¤ ê°œë°œ ê²½í—˜
- Docker + Windows/Linux í™˜ê²½ì—ì„œì˜ ì•ˆì •ì„± ê°œì„  í•™ìŠµ
- AudioWorkletì„ í†µí•œ ì‹¤ì‹œê°„ ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì „ì†¡ ê²½í—˜
- ì‹¤ë¬´ ì‹œìŠ¤í…œ ì„¤ê³„ + ìµœì í™” + MSA ê¸°ë°˜ êµ¬ì„±ê¹Œì§€ ì„±ê³µì ìœ¼ë¡œ ì™„ìˆ˜

---

## ğŸ“¢ ì£¼ì˜ì‚¬í•­

ë³¸ í”„ë¡œì íŠ¸ëŠ” í•™ìŠµ ë° ë°ëª¨ìš©ì´ë©°, ì‹¤ì œ ì„œë¹„ìŠ¤ ë°°í¬ ì‹œ HTTPS ë° ë³´ì•ˆ ì„¤ì •ì„ ë°˜ë“œì‹œ ê°•í™”í•˜ì„¸ìš”.