# WhisperTextAnalyzer

WhisperTextAnalyzerëŠ” ì‹¤ì‹œê°„ ìŒì„± ìŠ¤íŠ¸ë¦¼ì„ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ê³  ê°ì • ë¶„ì„ì„ ìˆ˜í–‰í•˜ëŠ” End-to-End íŒŒì´í”„ë¼ì¸ ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

---

## ğŸ“Œ í”„ë¡œì íŠ¸ ê°œìš”

- í´ë¼ì´ì–¸íŠ¸ ë¸Œë¼ìš°ì €ì—ì„œ **MediaRecorder (Web Audio API ê¸°ë°˜)**ë¡œ ë§ˆì´í¬ ì…ë ¥ì„ ìº¡ì²˜í•˜ì—¬ FastAPI ì„œë²„ë¡œ ì „ì†¡
- **FastAPI WebSocket ì„œë²„**ê°€ ì˜¤ë””ì˜¤ Blob ë°ì´í„°ë¥¼ ìˆ˜ì‹  í›„ Redis audio_queueì— ì €ì¥
- **stt_worker (Celery Worker)**ê°€ audio_queue ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ **OpenAI Whisper ëª¨ë¸**ë¡œ STT (Speech-to-Text) ë³€í™˜
- í…ìŠ¤íŠ¸ë¥¼ Redis text_queueë¡œ ì „ë‹¬
- **analyzer_worker (Celery Worker)**ê°€ text_queueì˜ í…ìŠ¤íŠ¸ë¥¼ **transformers ê¸°ë°˜ ê°ì • ë¶„ì„ ëª¨ë¸**(`distilbert-base-uncased-finetuned-sst-2-english`)ë¡œ ë¶„ì„
- ë¶„ì„ ê²°ê³¼ëŠ” Redis PubSubì˜ result_channelë¡œ publish
- **listener ì„œë¹„ìŠ¤**ê°€ result_channelì„ êµ¬ë…í•˜ì—¬ ê²°ê³¼ ë° í†µê³„ ì •ë³´ë¥¼ íŒŒì¼(`result_listener.log`) + ì½˜ì†”ì— ì¶œë ¥
- ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©ìëŠ” Web UIì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ìì‹ ì˜ ìŒì„± í…ìŠ¤íŠ¸ + ê°ì • ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸ ê°€ëŠ¥
---

## ğŸ› ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## ğŸ› ï¸ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
````
Client (ë¸Œë¼ìš°ì €: MediaRecorder â†’ WebSocket) //(loacl testëŠ” recorder ì„œë¹„ìŠ¤)
â†“
FastAPI ì„œë¹„ìŠ¤ (audio_queueë¡œ Redis push)
â†“
Redis (audio_queue â†’ text_queue â†’ PubSub result_channel)
â†“
stt_worker (Celery + Whisper ëª¨ë¸ â†’ text_queueë¡œ push)
â†“
analyzer_worker (Celery + transformers ê°ì • ë¶„ì„ â†’ result_channelë¡œ publish)
â†“
listener (result_channel êµ¬ë… â†’ ì½˜ì†” + íŒŒì¼ë¡œ ì¶œë ¥)
````
---

## âš™ï¸ ì£¼ìš” ê¸°ìˆ  ìŠ¤íƒ

- FastAPI + WebSocket
- MediaRecorder (Web Audio API ê¸°ë°˜)
- Redis (Queue + Pub/Sub)
- Celery (ë¹„ë™ê¸° Worker ê´€ë¦¬)
- Whisper (STT ëª¨ë¸, OpenAI Whisper ê¸°ë°˜)
- Huggingface Transformers (`distilbert-base-uncased-finetuned-sst-2-english` ê°ì • ë¶„ì„)
- Docker + Docker Compose
- 
---

## ğŸ§© ê°œë°œ ì¤‘ ê²ªì—ˆë˜ ë¬¸ì œ ë° í•´ê²° ë°©ë²•

### 1. Python whisper vs openai-whisper í˜¼ìš© ë¬¸ì œ
- ì´ˆê¸°ì—ëŠ” **íŒ¨í‚¤ì§€ whisper**ì™€ **ëª¨ë“ˆ whisper(openai-whisper)**ê°€ í˜¼ìš©ë˜ì–´ ì¶©ëŒ ë°œìƒ
- íŠ¹íˆ **Celery workerì˜ -A ì¸ìì—ì„œ worker íŒŒì¼ëª…ê³¼ whisper íŒ¨í‚¤ì§€ëª…ì´ ì¶©ëŒ** â†’ Celery app load ì‹¤íŒ¨
- **í•µì‹¬ í•´ê²°**
  - worker íŒŒì¼ëª…ì„ `stt_worker.py`, `analyzer_worker.py` ë“±ìœ¼ë¡œ ëª…í™•í•˜ê²Œ ì„¤ì • (ì ˆëŒ€ whisper.py ì“°ì§€ ì•ŠìŒ)
  - Celery ì‹¤í–‰ ì‹œ `celery -A stt_worker:celery_app worker --concurrency=1 --pool=solo`ë¡œ ì •í™•í•˜ê²Œ ëª¨ë“ˆ ì§€ì •
- **ì¶”ê°€ ì•ˆì „ì±…**
  - ì½”ë“œì—ì„œ import í˜¼ë™ ë°©ì§€ë¥¼ ìœ„í•´ `import whisper as openai_whisper`ë¡œ ë³€ê²½

### 2. Windows í™˜ê²½ ê°œë°œ ì‹œ ì œí•œ ì‚¬í•­

- Windows + Docker í™˜ê²½ì—ì„œ **Celery worker ì»¨í…Œì´ë„ˆ ë¹„ì •ìƒ ì¢…ë£Œ, crash** ë°œìƒ
- ì›ì¸: **WindowsëŠ” fork() ë¯¸ì§€ì› â†’ spawn() ë°©ì‹ìœ¼ë¡œ ë¶ˆì•ˆì •**
- ë©€í‹° concurrency ì„¤ì • ì‹œ ë¬¸ì œ ì‹¬í™” â†’ ë°˜ë“œì‹œ `--pool=solo` ì„¤ì • í•„ìš”  
  â†’ `--pool=solo`: **ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤, ë‹¨ì¼ ìŠ¤ë ˆë“œë¡œë§Œ ì‹¤í–‰í•˜ë„ë¡ ê°•ì œ** (Windows í™˜ê²½ì—ì„œ ì•ˆì •ì„± í™•ë³´)
- Dockerì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ **í˜¸ìŠ¤íŠ¸ ë§ˆì´í¬ ì‚¬ìš© ë¶ˆê°€**
- í•´ê²°:
  - `record` ì„œë¹„ìŠ¤ë§Œ ë¡œì»¬ Python í”„ë¡œì„¸ìŠ¤ë¡œ ì‹¤í–‰
  - ë‚˜ë¨¸ì§€ ì„œë¹„ìŠ¤(`fastapi_service`, `stt_worker`, `redis`)ëŠ” Dockerë¡œ ìš´ì˜
  - ë˜ëŠ” Redisë§Œ Docker, ë‚˜ë¨¸ì§€ëŠ” ë¡œì»¬ë¡œ ì¡°í•© í…ŒìŠ¤íŠ¸

#### âœ… Windows vs Linux â†’ Celery ë©€í‹° í”„ë¡œì„¸ìŠ¤ ì°¨ì´

| ì‹œìŠ¤í…œ | fork() ì§€ì› | Celery ë©€í‹°í”„ë¡œì„¸ìŠ¤ | ê²°ê³¼ |
|-------|-------------|---------------------|------|
| Linux, macOS | âœ… ì§€ì› (`fork()`) | ì •ìƒ ì‘ë™ | ë¬¸ì œ ì—†ìŒ |
| Windows | âŒ ë¯¸ì§€ì› â†’ `spawn()` | ë¶ˆì•ˆì • | worker crash, hang |

#### âœ… fork() vs spawn() ìš”ì•½

| ë°©ì‹ | íŠ¹ì§• | ë¹„ìœ  |
|------|------|------|
| **fork()** | ë¶€ëª¨ ë©”ëª¨ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ë³µì œ â†’ ë¹ ë¥´ê³  ì•ˆì •ì  | ë³µì‚¬ê¸°ë¡œ ì¦‰ì‹œ ë³µì‚¬ |
| **spawn()** | ìƒˆ í”„ë¡œì„¸ìŠ¤ë¡œ ì‹œì‘ â†’ RAM, CPU ì¶”ê°€ ì†Œëª¨ | ìƒˆ ì»´í“¨í„°ì— í”„ë¡œê·¸ë¨ ì¬ì„¤ì¹˜ |

#### âœ… Windowsì—ì„œ spawn()ì˜ ë¬¸ì œ

- `spawn()`ì€ ìƒˆë¡œ Python interpreter + ëª¨ë“  ëª¨ë“ˆ + celery contextë¥¼ ë‹¤ì‹œ ë¡œë“œ â†’ **RAM, CPU ì‚¬ìš©ëŸ‰ ì¦ê°€**
- Docker + Celery + Windows ì¡°í•©ì—ì„œ child processë“¤ì´ redis, broker ì—°ê²° ì‹¤íŒ¨ â†’ **ì£½ìŒ, hang, crash**
- ì‹¤ì§ˆì ìœ¼ë¡œ **Windowsì—ì„œëŠ” Celery ë©€í‹° í”„ë¡œì„¸ìŠ¤ ì‚¬ìš© ë¶ˆê°€**

### 3. ë¦¬ëˆ…ìŠ¤ ì„œë²„ (Azure Linux VM) ë°°í¬ ì‹œ ì–´ë ¤ì›€
- ë¦¬ëˆ…ìŠ¤ëŠ” ìœˆë„ìš°ì™€ ë‹¬ë¼ ê²½ë¡œ, íŒŒì¼ ê¶Œí•œ ë“±ì—ì„œ ì°¨ì´ê°€ ì¡´ì¬
- ì˜ˆìƒì¹˜ ëª»í•œ permission ë¬¸ì œ, Redis ì ‘ì† ë¬¸ì œ ë°œìƒ
- **í•´ê²°**: Azure VM í™˜ê²½ ë§ì¶° Docker ì¬ì…‹íŒ…í•˜ê³  FastAPI ì„œë²„, Redis ì„œë²„ ë”°ë¡œ íŠœë‹

### 4. STT ì„œë¹„ìŠ¤ì˜ ìƒ˜í”Œë§ ì£¼íŒŒìˆ˜ ë¬¸ì œ (ì‹¤ì‹œê°„ FastAPI ì†Œì¼“ í†µì‹ )

Whisper ëª¨ë¸(STT)ì€ **16,000Hz (16kHz)** ìƒ˜í”Œë§ì„ ìš”êµ¬í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ ë¸Œë¼ìš°ì €, ëª¨ë°”ì¼, ë””ë°”ì´ìŠ¤ ë§ˆì´í¬ì˜ ê¸°ë³¸ ìƒ˜í”Œë§ì€ ë³´í†µ **44,100Hz**, **48,000Hz** ë“±ìœ¼ë¡œ ë‹¤ì–‘í•˜ì—¬ **ìƒ˜í”Œë§ ë¶ˆì¼ì¹˜ ë¬¸ì œ**ê°€ ë°œìƒí•©ë‹ˆë‹¤.

FastAPI WebSocketìœ¼ë¡œ ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹œ ì„œë²„ì—ì„œ **Whisper ì…ë ¥ìš© PCM ë°ì´í„°**ë¡œ ì „ì†¡í•´ì•¼ í•©ë‹ˆë‹¤.

---

#### âœ” ê¸°ì¡´ ë¬¸ì œì 

ê¸°ì¡´ **MediaRecorder**, **ScriptProcessorNode** ë°©ì‹ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤.

- AudioContext sampleRate mismatch
- 500ms chunk delay â†’ ì‹¤ì‹œê°„ì„± í•œê³„
- Redisë¡œ ë°ì´í„° ì „ì†¡ ì‹œ ë”œë ˆì´ ë° ëˆ„ë½ ë¬¸ì œ

---

#### âœ” ìµœì¢… ê°œì„ : AudioWorklet ì ìš©

- **AudioWorklet + AudioContext({ sampleRate: 16000 })**ìœ¼ë¡œ ì§ì ‘ **16kHz ìŠ¤íŠ¸ë¦¼ ìƒì„±**
- ë¸Œë¼ìš°ì €ì—ì„œ ì‹¤ì‹œê°„ **PCM Float32 buffer** ìƒì„± â†’ **FastAPI WebSocket**ìœ¼ë¡œ ì¦‰ì‹œ ì „ì†¡
- ì„œë²„ì—ì„œëŠ” ë³„ë„ì˜ downsampling ì—†ì´ ë°”ë¡œ **Redis audio_queue**ë¡œ push ê°€ëŠ¥

---

#### âœ” ê²°ê³¼

- ì§„ì§œ **low-latency ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬** ì™„ì„±
- ë²„í¼ í¬ê¸°ë¥¼ **128~512 frame ìˆ˜ì¤€**ìœ¼ë¡œ ì¡°ì ˆ ê°€ëŠ¥ â†’ **1020ms ë‹¨ìœ„ ì „ì†¡** â†’ ê±°ì˜ í†µí™” ìˆ˜ì¤€ì˜ ì‹¤ì‹œê°„ì„± í™•ë³´
- ë°ì´í„° ì†ì‹¤ ë° ì§€ì—° ë¬¸ì œ ì™„ë²½ í•´ê²°
- Whisper, Celery stt_worker êµ¬ì¡° ë³€ê²½ ì—†ì´ ê·¸ëŒ€ë¡œ í˜¸í™˜

### 5. HTTPS ì¸ì¦ ê´€ë ¨ ì´ìŠˆ (ë¸Œë¼ìš°ì € ë§ˆì´í¬ ê¶Œí•œ)
- ì‹¤ì„œë²„ ë°°í¬ ì‹œ HTTPSê°€ ì—†ìœ¼ë©´ ë¸Œë¼ìš°ì €ê°€ ë§ˆì´í¬ ì ‘ê·¼ ì°¨ë‹¨
- Let's Encryptë¡œ ë¬´ë£Œ SSL ë°œê¸‰ ì‹œë„í–ˆì§€ë§Œ, ê´€ë¦¬ ë³µì¡ + ì‹œê°„ ë¬¸ì œ

### 6. ngrokìœ¼ë¡œ ìš°íšŒ í…ŒìŠ¤íŠ¸
- ê°„ë‹¨íˆ `ngrok http 8000`ì„ ì‚¬ìš©í•´ HTTPS ìš°íšŒ
- **ë‹¨ì **: ngrok ë¬´ë£Œ ë²„ì „ì€ 1ì‹œê°„ë§ˆë‹¤ ì£¼ì†Œê°€ ë°”ë€œ
- **ì¥ì **: ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸, ëª¨ë°”ì¼ ì ‘ì†, ë‹¤ë¥¸ PC ì ‘ì† ë“± ì‰½ê²Œ í•´ê²° ê°€ëŠ¥

### 7. FastAPI WebSocket ë°ì´í„° ìˆ˜ì‹  ë¬¸ì œ

ì´ˆê¸° ë²„ì „ì—ì„œëŠ” FastAPI ì„œë²„ì—ì„œ WebSocketìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ë°ì´í„°ë¥¼ `await websocket.receive()`ë¡œ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤. ì´ ë°©ì‹ì€ FastAPIì—ì„œ dict í˜•íƒœë¡œ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ëŠ”ë°, ë¸Œë¼ìš°ì € ì¸¡ì—ì„œ binary ë°ì´í„°ë¥¼ ë³´ë‚¼ ê²½ìš° ë°ì´í„°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¥´ê²Œ ë³€í˜•ë˜ê±°ë‚˜ key issueê°€ ë°œìƒí•˜ëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤. íŠ¹íˆ AudioWorkletì—ì„œ ì „ì†¡í•œ PCM Float32 binary bufferê°€ ì†ì‹¤ë˜ê±°ë‚˜ ì œëŒ€ë¡œ ì „ë‹¬ë˜ì§€ ì•ŠëŠ” í˜„ìƒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

ì´ì— ë”°ë¼ WebSocketì—ì„œ binary ë°ì´í„°ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ìˆ˜ì‹ í•˜ë ¤ë©´ `await websocket.receive_bytes()`ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ í‘œì¤€ì…ë‹ˆë‹¤. ì´ ë°©ì‹ì€ ìˆœìˆ˜ binary ë°ì´í„°ë§Œ ì§ìˆ˜ì‹ í•  ìˆ˜ ìˆì–´ ë°ì´í„° ì†ì‹¤ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

| ê¸°ì¡´ ë°©ì‹ | ê°œì„  ë°©ì‹ |
|-----------|-----------|
| await websocket.receive() â†’ dict ë°˜í™˜ + ë¶ˆì•ˆì • | await websocket.receive_bytes() â†’ bytes ì§ìˆ˜ì‹  |
| ë¸Œë¼ìš°ì €ì—ì„œ binary chunk ë³´ë‚¼ ë•Œ dict key issue ìˆìŒ | binary-only streamì´ë©´ receive_bytesë¡œ ë°”ë¡œ ë°›ëŠ” ê²Œ í‘œì¤€ |

íŠ¹íˆ AudioWorkletì—ì„œ `postMessage(channelData.buffer)` â†’ WebSocket â†’ FastAPIë¡œ ì „ë‹¬ë˜ëŠ” binary ë°ì´í„°ëŠ” ë¬´ì¡°ê±´ `receive_bytes()`ë¡œ ì²˜ë¦¬í•´ì•¼ë§Œ ë°ì´í„° ì†ì‹¤ì´ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

### 8. Docker multi-container í™˜ê²½ì—ì„œ Python module import ë¶ˆê°€ ë¬¸ì œ ë° Celery task triggerë¡œ ê°œì„ 

FastAPIì™€ stt_workerë¥¼ ì„œë¡œ ë‹¤ë¥¸ Docker ì»¨í…Œì´ë„ˆë¡œ ë¶„ë¦¬í–ˆì„ ë•Œ, FastAPIì—ì„œ `from stt_worker import transcribe_audio` í˜¸ì¶œ ì‹œ Celery task triggerê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

#### ì›ì¸
- Docker ì»¨í…Œì´ë„ˆëŠ” ì„œë¡œ íŒŒì¼ ì‹œìŠ¤í…œì„ ê³µìœ í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— FastAPI ì»¨í…Œì´ë„ˆì—ì„œëŠ” stt_worker ì»¨í…Œì´ë„ˆì˜ ëª¨ë“ˆì„ importí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
- ì´ˆê¸°ì—ëŠ” stt_worker, analyzer_worker ìì²´ polling êµ¬ì¡° (`while True`ë¡œ Redis queueë¥¼ ë°˜ë³µ í™•ì¸)ë¡œ ë°ì´í„°ë¥¼ ê°€ì ¸ê°€ë„ë¡ í–ˆì§€ë§Œ, ì»¨í…Œì´ë„ˆ ë¶„ë¦¬ ì´í›„ FastAPIì—ì„œ ì§ì ‘ task í˜¸ì¶œì´ ë¶ˆê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤.
- ë˜í•œ polling êµ¬ì¡°ëŠ” í™•ì¥ì„±, íš¨ìœ¨ì„± ì¸¡ë©´ì—ì„œ í•œê³„ê°€ ìˆì—ˆê³ , Workerê°€ ì²˜ë¦¬ ì¤‘ì¼ ê²½ìš° queue backlogë¡œë§Œ ëŒ€ê¸°í•˜ëŠ” êµ¬ì¡°ì˜€ìŠµë‹ˆë‹¤.

#### ê°œì„  ë° í•´ê²°
- í˜„ì—…ì—ì„œëŠ” ì»¨í…Œì´ë„ˆ ê°„ couplingì„ í”¼í•˜ê¸° ìœ„í•´ ì§ì ‘ Python import ëŒ€ì‹  Celeryì˜ `send_task()` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- FastAPIëŠ” task ì´ë¦„ (`"stt_worker.transcribe_audio"`)ê³¼ argument (ì˜ˆ: bytes ë°ì´í„°)ë¥¼ Redis brokerë¡œ ì „ë‹¬í•˜ê³ , Celery workerê°€ Redis queueì—ì„œ í•´ë‹¹ taskë¥¼ subscribeí•˜ì—¬ ì‹¤í–‰í•©ë‹ˆë‹¤.
- CeleryëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ëª¨ë“  Python object (`bytes`, `str`, `dict`, `list` ë“±)ë¥¼ ì§ë ¬í™”(=ë°”ì´íŠ¸í™”)í•˜ì—¬ Redis queueì— ì €ì¥í•©ë‹ˆë‹¤.  
ì¦‰, Workerê°€ ë°”ì  ê²½ìš°ì—ë„ taskëŠ” Redis broker queueì— ì•ˆì „í•˜ê²Œ ìŒ“ì—¬ ëŒ€ê¸°í•˜ê²Œ ë©ë‹ˆë‹¤.
- ì´ ë°©ë²•ìœ¼ë¡œ ì»¨í…Œì´ë„ˆ ê°„ ì™„ë²½í•œ ë…ë¦½ì„±ì„ ìœ ì§€í•˜ë©°, í™•ì¥ì„±ê³¼ ì•ˆì •ì„±ì´ í–¥ìƒë©ë‹ˆë‹¤.

```python
# âœ… ê°œì„ ëœ ì‹¤ë¬´í˜• Celery task trigger
# FastAPI â†’ Celery broker (Redis)ë¡œ ì§ì ‘ task ì „ë‹¬
# audio_chunkëŠ” bytes ê°ì²´ ê·¸ëŒ€ë¡œ ì „ë‹¬ ê°€ëŠ¥
celery_app.send_task("stt_worker.transcribe_audio", args=[audio_chunk])
```
ì¶”ê°€ ì„¤ëª…
ì´ì „ polling êµ¬ì¡°ì—ì„œëŠ” FastAPI â†’ Redis audio_queue push â†’ Workerê°€ r.rpop()ìœ¼ë¡œ pollingí•˜ì—¬ ê°€ì ¸ê°”ì§€ë§Œ,
ê°œì„  êµ¬ì¡°ì—ì„œëŠ” send_task()ë¡œ ì§ì ‘ Workerì—ê²Œ ì „ë‹¬ â†’ WorkerëŠ” ë°”ë¡œ ì¸ìë¡œ ê°’ì„ ì „ë‹¬ë°›ì•„ ì²˜ë¦¬.
ë”°ë¼ì„œ ê°œì„  í›„ì—ëŠ” Redis audio_queue / text_queueë¥¼ ì‚¬ìš©í•  í•„ìš”ê°€ ì—†ìœ¼ë©°, r.lpush(), r.rpop() ì½”ë“œ ë˜í•œ ì‚­ì œë©ë‹ˆë‹¤.
Celeryì˜ send_task()ëŠ” í˜¸ì¶œ ì‹œì ì— Redis broker queueì— taskë¥¼ ë“±ë¡í•˜ê³ ,
Workerê°€ idle ìƒíƒœê°€ ë˜ë©´ queueì—ì„œ taskë¥¼ ê°€ì ¸ì™€ ë°”ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.
Redis broker queueëŠ” ì‹¤ì§ˆì ì¸ task buffer ì—­í• ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### 9. Celery í˜¸ì¶œì‹ ì§ë ¬í™” ë° Redis broker ì—­í•  ì •ë¦¬

FastAPI â†’ STT worker, STT worker â†’ Analyzer worker í˜¸ì¶œ ì‹œ Celeryì˜ send_task() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

CeleryëŠ” task í˜¸ì¶œ ì‹œ Python object (ì˜ˆ: str, list ë“±)ë¥¼ ìë™ìœ¼ë¡œ JSON ì§ë ¬í™”í•˜ì—¬ Redis brokerì— ì €ì¥í•©ë‹ˆë‹¤.

RedisëŠ” ë‹¨ìˆœ queue ì—­í• ë§Œ í•˜ë©°, ë°ì´í„° ë‚´ìš©ì„ ë³€í˜•í•˜ê±°ë‚˜ í•´ì„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

âœ… í•µì‹¬ ìš”ì•½  
ì§ë ¬í™”(serialize)ì™€ ë³µì›(deserialize)ì€ Celeryê°€ ì „ë¶€ ì•Œì•„ì„œ ì²˜ë¦¬í•œë‹¤.  
RedisëŠ” ê·¸ì € ì €ì¥ì†Œ ì—­í• ë§Œ í•œë‹¤.  
Worker í•¨ìˆ˜ ì•ˆì—ì„œëŠ” Python object (str, list ë“±)ë¡œ ì´ë¯¸ ë³µì›ëœ ì¸ìë¥¼ ë°›ëŠ”ë‹¤.

WorkerëŠ” Redisì—ì„œ taskë¥¼ ê°€ì ¸ì˜¬ ë•Œ, Celeryê°€ JSONì„ ë””ì½”ë“œí•˜ì—¬ Python objectë¡œ ë³µì›í•œ í›„ task í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.

ë”°ë¼ì„œ Worker í•¨ìˆ˜(analyze_text ë“±)ëŠ” í•­ìƒ Python native objectë¥¼ ì¸ìë¡œ ì „ë‹¬ë°›ìŠµë‹ˆë‹¤. (ex. str, list ë“±)

### 10. base64ì˜ ì´ìƒí•œ ë¬¸ì ì›ë¦¬ì™€ ì‹¤ë¬´ ì‚¬ìš© ì´ìœ 

ì‹¤ë¬´ì—ì„œ ì´ë¯¸ì§€, ì˜¤ë””ì˜¤, ë°”ì´ë„ˆë¦¬ íŒŒì¼ ë“± **binary data (bytes)**ë¥¼ networkë¡œ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ë ¤ë©´  
**text-only ì‹œìŠ¤í…œ (ì˜ˆ: JSON, XML, HTTP, WebSocket ë“±)**ì„ í†µê³¼í•´ì•¼ í•˜ëŠ” ê²½ìš°ê°€ ë§ìŠµë‹ˆë‹¤.  
í•˜ì§€ë§Œ ì´ëŸ¬í•œ ì‹œìŠ¤í…œì€ raw bytesë¥¼ ì „ë‹¬í•  ìˆ˜ ì—†ì–´ **ê¹¨ì§, ì˜¤ë¥˜, ì˜ˆê¸°ì¹˜ ì•Šì€ ë™ì‘**ì´ ë°œìƒí•©ë‹ˆë‹¤.

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë“±ì¥í•œ ê²ƒì´ **base64 ì¸ì½”ë”©**ì…ë‹ˆë‹¤.

---

#### âœ… base64ì˜ ì›ë¦¬

```plaintext
bytes (binary data) â†’ base64 ì¸ì½”ë”© â†’ ì‚¬ëŒì´ ì½ì„ ìˆ˜ ìˆëŠ” ASCII ë¬¸ì (str)
```

base64ëŠ” **64ê°œì˜ ë¬¸ì ì§‘í•© (A-Z, a-z, 0-9, +, /)**ë§Œ ì‚¬ìš©í•˜ì—¬  
ì–´ë–¤ binary dataë¼ë„ **ê¹¨ì§€ì§€ ì•ŠëŠ” ë¬¸ìì—´ë¡œ ë³€í™˜**í•©ë‹ˆë‹¤.

ì´ ë¬¸ìì—´ì€ ì‚¬ëŒì´ ì½ìœ¼ë©´ ì˜ë¯¸ ì—†ëŠ” ì•ŒíŒŒë²³, ìˆ«ì, íŠ¹ìˆ˜ê¸°í˜¸ ì¡°í•©ìœ¼ë¡œ ë³´ì´ì§€ë§Œ  
**ì‹¤ì œë¡  ì›ë³¸ binaryë¥¼ ì™„ë²½í•˜ê²Œ ë³µì›í•  ìˆ˜ ìˆëŠ” ë¬¸ìì—´ í¬ë§·**ì…ë‹ˆë‹¤.

---

#### âœ… ì˜ˆì‹œ ì½”ë“œ

```python
import base64

# ì˜ˆ: ì›ë³¸ binary ë°ì´í„°
data = b'\x89PNG\r\n\x1a\n...'  # ì´ë¯¸ì§€ë‚˜ ì˜¤ë””ì˜¤ íŒŒì¼ ë“±

# base64 ì¸ì½”ë”© â†’ strë¡œ ë³€í™˜
b64_string = base64.b64encode(data).decode('utf-8')
print(b64_string)  # â†’ ì‚¬ëŒì´ ë³´ë©´ ì´ìƒí•˜ì§€ë§Œ JSON-safe ë¬¸ìì—´

# base64 ë””ì½”ë”© â†’ ì›ë˜ bytesë¡œ ë³µì›
restored_data = base64.b64decode(b64_string)
```

ì¶œë ¥ ì˜ˆì‹œ:
```
iVBORw0KGgoAAAANSUhEUgAA...
```

---

#### âœ… í•µì‹¬ ìš”ì•½

| ë‹¨ê³„ | ì—­í•  |
|------|------|
| ì›ë³¸ data | bytes (binary) |
| base64 ì¸ì½”ë”© | ì´ìƒí•œ ë¬¸ìë¡œ ë³´ì´ëŠ” ASCII ë¬¸ìì—´ (str) |
| ìš©ë„ | text-only ì‹œìŠ¤í…œì—ì„œ binaryë¥¼ ì•ˆì „í•˜ê²Œ ì „ë‹¬í•˜ê¸° ìœ„í•´ |

ì¦‰, base64 ì¸ì½”ë”©ì€  
```
ë°”ì´íŠ¸ë¥¼ ì´ìƒí•œ ë¬¸ì(str)ë¡œ ë°”ê¿”ì„œ ì €ì¥í•˜ê³  ë³´ë‚´ëŠ” ê³¼ì • â†’ YES!
```

ì‹¤ì œë¡œ ì‹¤ë¬´ì—ì„œëŠ” Celery + Redis ë˜ëŠ” Web APIì—ì„œ image, audio, videoë¥¼ ì „ë‹¬í•  ë•Œ **í•„ìˆ˜ í‘œì¤€ ë°©ì‹**ìœ¼ë¡œ ì‚¬ìš©ë©ë‹ˆë‹¤.

---


---

#### âœ… ì£¼ìš” ì •ë¦¬

| êµ¬ê°„ | ì—­í•  | íŠ¹ì§• |
|------|------|------|
| FastAPI â†’ Celery Broker | JSON ì§ë ¬í™” | Python object â†’ JSON bytes ë³€í™˜ í›„ Redisì— ì €ì¥ |
| Redis Broker | ë°ì´í„° ì €ì¥ | ì•„ë¬´ê²ƒë„ ë³€í˜•í•˜ì§€ ì•Šê³  ì €ì¥ë§Œ í•¨ |
| Celery Worker â†’ Task | JSON ë””ì½”ë“œ | Redisì—ì„œ ì½ì€ í›„ Python objectë¡œ ë³µì› |

FastAPIì—ì„œ Celeryë¡œ ë„˜ê¸°ëŠ” audio_chunkëŠ” bytesì´ê³ ,  
STTì—ì„œ Analyzerë¡œ ë„˜ê¸°ëŠ” textëŠ” stringì…ë‹ˆë‹¤.

stringì€ JSON ì§ë ¬í™”/ë³µì›ì´ ìì—°ìŠ¤ëŸ½ê¸° ë•Œë¬¸ì— base64 ë³€í™˜ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.

ê²°ê³¼ì ìœ¼ë¡œ analyze_text(text)ì˜ textëŠ” strì´ê¸° ë•Œë¬¸ì— .decode()ë¥¼ í˜¸ì¶œí•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

listener_serviceì²˜ëŸ¼ Redis pubsubì„ ì§ì ‘ ë‹¤ë£¨ëŠ” ê²½ìš°ì—ëŠ” message["data"].decode()ë¥¼ í•´ì¤˜ì•¼ í•˜ì§€ë§Œ,  
Celery taskë¡œ ë°›ì€ ë°ì´í„°ëŠ” ì´ë¯¸ ë³µì›ëœ Python objectë¼ decode ì—†ì´ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.

### 11. Docker build context + COPY ëª…ë ¹ì–´ ë™ì‘ ì›ë¦¬ + ì‹¤ë¬´ íŒŒì¼ êµ¬ì¡° ì˜ˆì‹œ

ì‹¤ë¬´ì—ì„œ Dockerfileì„ ì‘ì„±í•  ë•Œ, `COPY` ëª…ë ¹ì–´ëŠ” **Docker build context**ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤.  
Docker build contextëŠ” `docker-compose.yml` ë˜ëŠ” `docker build` ëª…ë ¹ì–´ì—ì„œ ì§€ì •í•©ë‹ˆë‹¤.

```Dockerfile
FROM python:3.10-slim

WORKDIR /app

RUN pip install --upgrade pip
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
```

---

#### âœ… ì›ë¦¬

1ï¸âƒ£ `WORKDIR /app` â†’ ì´í›„ ëª¨ë“  ì‘ì—… ê²½ë¡œëŠ” ì»¨í…Œì´ë„ˆ ë‚´ë¶€ `/app`ìœ¼ë¡œ ê³ ì •ë¨  
2ï¸âƒ£ `COPY requirements.txt .` â†’ build context ê¸°ì¤€ìœ¼ë¡œ `requirements.txt`ë§Œ ë³µì‚¬  
3ï¸âƒ£ `COPY . .` â†’ build context ë‚´ **ëª¨ë“  íŒŒì¼, í´ë”**ë¥¼ `/app`ìœ¼ë¡œ ë³µì‚¬

âœ… build context = `./stt_worker`ë¼ë©´ ì»¨í…Œì´ë„ˆ ì•ˆ `/app` êµ¬ì¡°ëŠ” ë‹¤ìŒê³¼ ê°™ìŒ:

```plaintext
/app/
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ sst_worker.py
```

(`Dockerfile`ì€ buildìš© íŒŒì¼ì´ë¼ ì»¨í…Œì´ë„ˆë¡œ ë³µì‚¬ë˜ì§€ ì•ŠìŒ)

---

#### âœ… ì£¼ì˜ì‚¬í•­

| ìƒí™© | ê²°ê³¼ |
|------|------|
| build context ì™¸ë¶€ íŒŒì¼ (`../some_file`) | ë³µì‚¬ ë¶ˆê°€ |
| ìˆ¨ê¹€ íŒŒì¼ (`.env`, `.gitignore`, ë“±) | í¬í•¨ë¨ (ë‹¨, `.dockerignore`ë¡œ ì œì™¸ ê°€ëŠ¥) |
| COPY . . | build contextì˜ ì „ì²´ íŒŒì¼ + í´ë” ë³µì‚¬ |
| Dockerfile | í¬í•¨ ì•ˆ ë¨ |

ì‹¤ë¬´ì—ì„œëŠ” ê¼­ `.dockerignore` íŒŒì¼ì„ ë§Œë“¤ì–´ ì œì™¸í•  í•­ëª©ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.

ì˜ˆì‹œ:
```plaintext
# .dockerignore ì˜ˆì‹œ
.git
__pycache__
*.pyc
venv
.idea
```

ì´ë¥¼ í†µí•´ **ì´ë¯¸ì§€ ìš©ëŸ‰ì„ ìµœì†Œí™”**í•˜ê³ , ë¶ˆí•„ìš”í•œ íŒŒì¼ì´ í¬í•¨ë˜ì§€ ì•Šë„ë¡ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

#### âœ… ê²°ë¡ 

```plaintext
ë‹¹ì‹  ìƒí™©ì—ì„œ build context = ./stt_worker ì´ë¯€ë¡œ
ì»¨í…Œì´ë„ˆ /app ì•ˆì—ëŠ” requirements.txt + sst_worker.py ë‘ íŒŒì¼ë§Œ ë“¤ì–´ê°„ë‹¤.
```

ì‹¤ì œ ì‹¤ë¬´ì—ì„œë„ ì´ êµ¬ì¡°ê°€ **ê°€ì¥ í‘œì¤€ì ì´ë©° ì¶”ì²œë˜ëŠ” ë°©ë²•**ì…ë‹ˆë‹¤.

### 12. openai-whisper íŒ¨í‚¤ì§€ ì¶©ëŒ ë¬¸ì œ ë° ì‹¤ë¬´ í•´ê²° ë°©ë²•

ë³¸ í”„ë¡œì íŠ¸ ê°œë°œ ì¤‘ ê°€ì¥ í° ì¥ì•  ì¤‘ í•˜ë‚˜ì˜€ë˜ ë¬¸ì œì…ë‹ˆë‹¤.  
ì²˜ìŒì— `whisper==1.1.10` íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í–ˆë”ë‹ˆ ì•„ë˜ì™€ ê°™ì€ ì‹¬ê°í•œ ì¶©ëŒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

```plaintext
import whisper as openai_whisper â†’ AttributeError, ModuleNotFoundError
```

ì´ìœ :
```
pypi.org ê¸°ì¤€, whisper==1.1.10ì€ openai whisperê°€ ì•„ë‹Œ
ì™„ì „íˆ ë‹¤ë¥¸ Graphite metrics íˆ´ whisper íŒ¨í‚¤ì§€ì˜€ìŠµë‹ˆë‹¤.
(ì§„ì§œ ì „ì„¸ê³„ Python ê°œë°œìë“¤ì´ ë‚šì´ëŠ” classic ë¬¸ì œ)
```

---

#### âœ… ë¬¸ì œ ìƒí™©
openai-whisper íŒ¨í‚¤ì§€ ë¬¸ì œ
```bash
pip install whisper==1.1.10
```

â†’ ì™„ì „íˆ ì—‰ëš±í•œ íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë¨ â†’ openai whisper ëª¨ë¸ ì‚¬ìš© ë¶ˆê°€

â†’ í•´ë‹¹ ë¬¸ì œë¡œ ì•½ í•˜ë£¨ ì´ìƒ ë””ë²„ê¹… ì†Œìš”ë¨

---

#### âœ… ìµœì¢… ì‹¤ë¬´ í•´ê²° ë°©ë²•

ì•„ë˜ì™€ ê°™ì´ `openai-whisper` íŒ¨í‚¤ì§€ ìµœì‹  ë²„ì „ì„ ëª…í™•í•˜ê²Œ ì„¤ì¹˜í•´ì•¼ë§Œ í–ˆìŠµë‹ˆë‹¤.

ìµœì¢… requirements.txt ì¡°í•©:
```plaintext
numpy==1.26.4
scipy==1.13.0
celery==5.3.6
redis==5.0.4
fastapi==0.115.2
uvicorn[standard]==0.29.0
torch==2.2.2+cpu
openai_whisper==20240930
-f https://download.pytorch.org/whl/torch_stable.html
```

í•µì‹¬ í¬ì¸íŠ¸:
- `openai_whisper==20240930` â†’ ì§„ì§œ openai whisper ìµœì‹  ì•ˆì • ë²„ì „
- `torch==2.2.2+cpu` + pytorch wheel source ëª…ì‹œ â†’ ì•ˆì •ì ì¸ CPU ë²„ì „ ì„¤ì¹˜
- ì‹¤ë¬´ì—ì„œë„ ê°€ì¥ ì•ˆì •ì ì¸ whisper + pytorch ì¡°í•©

---

#### âœ… ì‹¤ë¬´ íŒ

ë˜ëŠ” ì‹¤ë¬´ì—ì„œëŠ” ì•„ë˜ì²˜ëŸ¼ë„ ë§ì´ ì„¤ì¹˜í•©ë‹ˆë‹¤.
```bash
pip install openai-whisper
```
â†’ `openai-whisper==2024xxxx` ìµœì‹  ë²„ì „ ìë™ ì„¤ì¹˜

í•˜ì§€ë§Œ ì—°êµ¬/ë°°í¬ í™˜ê²½ì—ì„œëŠ” í•­ìƒ ëª…í™•í•œ ë²„ì „ ê³ ì •ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

---

#### âœ… ë°œí‘œ/ë¬¸ì„œ ì£¼ì˜ í¬ì¸íŠ¸

```plaintext
whisper íŒ¨í‚¤ì§€ëŠ” ë°˜ë“œì‹œ openai-whisperë¡œ ëª…í™•í•˜ê²Œ ì§€ì •í•´ì•¼ í•©ë‹ˆë‹¤.
whisper==1.1.10 ì ˆëŒ€ ì„¤ì¹˜ ê¸ˆì§€ â†’ ì „í˜€ ë‹¤ë¥¸ íŒ¨í‚¤ì§€ì…ë‹ˆë‹¤.
```
## 13.Celery Taskì—ì„œ ì „ìš© íë¥¼ ë¯¸ì§€ì •
### ğŸ¯ ë¬¸ì œ ì›ì¸
Docker multi-container êµ¬ì¡°ì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  Celery workerê°€ ê¸°ë³¸ queue(`"celery"`)ë¥¼ êµ¬ë…í•©ë‹ˆë‹¤.  
ì´ë¡œ ì¸í•´ **ëª¨ë“  workerê°€ ëª¨ë“  taskë¥¼ ìˆ˜ì‹ í•˜ë ¤ ì‹œë„** â†’ ìê¸° taskê°€ ì•„ë‹ˆë©´ KeyErrorê°€ ë°œìƒí•©ë‹ˆë‹¤.
### âœ… í•´ê²° ì›ì¹™
**ê° workerëŠ” ê³ ìœ  queueë§Œ êµ¬ë…**í•˜ê³ ,  
**FastAPIì—ì„œ send_task ì‹œ ëª…í™•í•˜ê²Œ queueë¥¼ ì§€ì •**
````
command: celery -A stt_worker:celery worker -Q stt_queue --loglevel=info
celery.send_task("stt_worker.transcribe_audio", args=[audio_chunk], queue="stt_queue")
@celery.task(name="stt_worker.transcribe_audio")
````
---
## ğŸ³ Dockerfile ë ˆì´ì–´ì™€ ìºì‹œ êµ¬ì¡° ì›ë¦¬

### âœ… Dockerfile ë¹Œë“œ ì‹œ ë ˆì´ì–´ êµ¬ì¡°
DockerëŠ” ê° ëª…ë ¹ì–´ë§ˆë‹¤ ë ˆì´ì–´ë¥¼ ìƒì„±í•˜ë©°, ë ˆì´ì–´ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ìŒ“ì¸ë‹¤.

FROM python:3.10-slim # Layer 1 (Base Image)
WORKDIR /app # Layer 2
RUN apt-get update &&
apt-get install -y ffmpeg &&
apt-get clean # Layer 3 (System Package Layer)
RUN pip install --upgrade pip # Layer 4 (Python Layer)
COPY requirements.txt . # Layer 5 (File Change Layer)
RUN pip install -r requirements.txt # Layer 6 (Dependency Layer)
COPY . . # Layer 7 (Source Code Layer)


### âœ… ë ˆì´ì–´ ìºì‹œì˜ ì›ì¹™
DockerëŠ” ë™ì¼í•œ ëª…ë ¹ì–´ + ë™ì¼í•œ íŒŒì¼ + ë™ì¼í•œ contextë¼ë©´ ì´ì „ ë ˆì´ì–´ë¥¼ ìºì‹œì—ì„œ ì¬ì‚¬ìš©í•œë‹¤.

ìºì‹œê°€ ìœ ì§€ë˜ëŠ” ì¡°ê±´:
- Dockerfile ë‚´ìš©ì´ ë³€ê²½ë˜ì§€ ì•Šì•˜ì„ ë•Œ
- Base Image (`FROM`)ê°€ ë™ì¼í•  ë•Œ
- `COPY`, `ADD` ë“±ìœ¼ë¡œ ë³µì‚¬ëœ íŒŒì¼ ë‚´ìš©ì´ ë™ì¼í•  ë•Œ
- Build context (`build: context:` ë””ë ‰í† ë¦¬) íŒŒì¼ ë³€ê²½ì´ ì—†ì„ ë•Œ

ìºì‹œê°€ ê¹¨ì§€ëŠ” ì¡°ê±´:
- Base Imageê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ
- Dockerfile ëª…ë ¹ì–´ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ
- requirements.txt íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œ (`COPY requirements.txt .`)
- ì†ŒìŠ¤ ì½”ë“œê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ (`COPY . .`)
- ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ëª…ë ¹ (`RUN apt-get install ...`)ì´ ì¶”ê°€ ë˜ëŠ” ë³€ê²½ë˜ì—ˆì„ ë•Œ

### âœ… docker-composeì˜ build contextì™€ ìºì‹œ
docker-composeì˜ `build: context:` ì„¤ì • ìì²´ëŠ” ìºì‹œë¥¼ ê¹¨ì§€ ì•ŠëŠ”ë‹¤.  
ë‹¨, í•´ë‹¹ context ë‚´ë¶€ íŒŒì¼ì´ ë³€ê²½ë˜ë©´ ìºì‹œê°€ ë¬´íš¨í™”ëœë‹¤.

- `docker-compose build` â†’ ë‚´ë¶€ì ìœ¼ë¡œ `docker build -f Dockerfile ./` ì™€ ë™ì¼
- stt_worker, analyzer_worker, fastapi_service ë“± contextê°€ ë‹¤ë¥´ë©´ ìºì‹œëŠ” ì„œë¡œ ì˜í–¥ì„ ì£¼ì§€ ì•ŠëŠ”ë‹¤.

### âœ… Best Practice
- ì‹œìŠ¤í…œ ë ˆì´ì–´ (`apt-get`) â†’ Python ë ˆì´ì–´ (`pip`) â†’ ì½”ë“œ ë³µì‚¬ ìˆœìœ¼ë¡œ ì‘ì„± ê¶Œì¥
- ë³€ê²½ ê°€ëŠ¥ì„±ì´ ë‚®ì€ ëª…ë ¹ì–´ë¥¼ ìœ„ì— ë‘ì–´ ìºì‹œ íš¨ìœ¨ì„ ê·¹ëŒ€í™”

**ì¶”ì²œ Dockerfile ì˜ˆì‹œ**
FROM python:3.10-slim
WORKDIR /app
RUN apt-get update && apt-get install -y ffmpeg && apt-get clean
RUN pip install --upgrade pip
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .

---
# WhisperTextAnalyzer ë°°í¬ ê°€ì´ë“œ

ì´ ë¬¸ì„œëŠ” **WhisperTextAnalyzer** ì• í”Œë¦¬ì¼€ì´ì…˜ì„ **nginx, Docker, FastAPI** í™˜ê²½ì—ì„œ ë°°í¬í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

## 1. **ì„œë²„ í™˜ê²½ ì„¤ì •**

### 1.1. **VMì— nginx ì„¤ì¹˜**
nginxëŠ” FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì— ëŒ€í•œ ìš”ì²­ì„ í”„ë¡ì‹œí•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤. `nginx`ë¥¼ ì„¤ì¹˜í•˜ë ¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```bash
sudo apt update
sudo apt install nginx
ì„¤ì¹˜ í›„ nginxê°€ ìë™ìœ¼ë¡œ ì‹¤í–‰ë˜ë©°, /etc/nginx/ ê²½ë¡œì—ì„œ nginx ì„¤ì •ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

1.2. SSL ì¸ì¦ì„œ ì„¤ì • (Let's Encrypt)
ì›¹ì‚¬ì´íŠ¸ì˜ HTTPS ì„¤ì •ì„ ìœ„í•´ Certbotì„ ì‚¬ìš©í•˜ì—¬ SSL ì¸ì¦ì„œë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.

bash
ë³µì‚¬
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d whisperproject.duckdns.org -d www.whisperproject.duckdns.org
ì´ ëª…ë ¹ì–´ëŠ” Let's Encryptë¡œë¶€í„° ë¬´ë£Œ SSL ì¸ì¦ì„œë¥¼ ìë™ìœ¼ë¡œ ë°›ì•„ nginx ì„¤ì •ì— ì¶”ê°€í•©ë‹ˆë‹¤.

2. nginx ì„¤ì •
nginx ì„¤ì • íŒŒì¼ì€ /etc/nginx/sites-available/defaultì—ì„œ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ HTTPë¥¼ HTTPSë¡œ ë¦¬ë””ë ‰ì…˜í•˜ê³ , Dockerë¡œ ì‹¤í–‰ ì¤‘ì¸ FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ìœ¼ë¡œ ìš”ì²­ì„ í”„ë¡ì‹œí•˜ëŠ” ì„¤ì •ì„ ì¶”ê°€í•©ë‹ˆë‹¤.

nginx
ë³µì‚¬
server {
    listen 80;
    server_name whisperproject.duckdns.org www.whisperproject.duckdns.org;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name whisperproject.duckdns.org;

    ssl_certificate /etc/letsencrypt/live/whisperproject.duckdns.org/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/whisperproject.duckdns.org/privkey.pem;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
2.1. ì„¤ì • í™•ì¸ ë° nginx ì¬ì‹œì‘
nginx ì„¤ì •ì„ ì™„ë£Œí•œ í›„, ì„¤ì •ì´ ì˜¬ë°”ë¥¸ì§€ ì ê²€í•˜ê³  nginxë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤.

bash
ë³µì‚¬
sudo nginx -t
sudo systemctl restart nginx
3. Docker í™˜ê²½ ì„¤ì •
3.1. Dockerfile ì¤€ë¹„
FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì„ Docker ì»¨í…Œì´ë„ˆì—ì„œ ì‹¤í–‰í•˜ë ¤ë©´ Dockerfileì„ ì¤€ë¹„í•©ë‹ˆë‹¤. ì•„ë˜ëŠ” ê¸°ë³¸ì ì¸ FastAPI Dockerfile ì˜ˆì‹œì…ë‹ˆë‹¤.

dockerfile
ë³µì‚¬
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .

RUN pip install --no-cache-dir -r requirements.txt

COPY . /app

CMD ["uvicorn", "fastapi_service:app", "--host", "0.0.0.0", "--port", "8000"]
3.2. Docker Compose ì‚¬ìš©
docker-compose.yml íŒŒì¼ì„ ì‚¬ìš©í•˜ì—¬ FastAPI ì»¨í…Œì´ë„ˆì™€ nginx ì»¨í…Œì´ë„ˆë¥¼ ë™ì‹œì— ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

yaml
ë³µì‚¬
version: '3'
services:
  app:
    image: fastapi_image
    build:
      context: .
    ports:
      - "8000:8000"
    restart: always  # ì»¨í…Œì´ë„ˆê°€ ë‹¤ìš´ë˜ë©´ ìë™ìœ¼ë¡œ ì¬ì‹œì‘

  nginx:
    image: nginx:latest
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - app
    restart: always  # nginxë„ ìë™ ì¬ì‹œì‘
3.3. Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
ì´ì œ docker-composeë¥¼ ì‚¬ìš©í•˜ì—¬ FastAPIì™€ nginx ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.

bash
ë³µì‚¬
docker-compose up --build -d
4. í…ŒìŠ¤íŠ¸
4.1. ë¸Œë¼ìš°ì € ì ‘ì†
ë¸Œë¼ìš°ì €ì—ì„œ https://whisperproject.duckdns.orgì— ì ‘ì†í•˜ì—¬ FastAPI ì„œë¹„ìŠ¤ê°€ ì •ìƒì ìœ¼ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

4.2. FastAPI ìƒíƒœ í™•ì¸
FastAPIê°€ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ë ¤ë©´ ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì—ì„œ ìƒíƒœë¥¼ ì ê²€í•©ë‹ˆë‹¤.

bash
ë³µì‚¬
curl http://127.0.0.1:8000
ì •ìƒì ìœ¼ë¡œ FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ JSON ì‘ë‹µì´ ë‚˜ì˜¨ë‹¤ë©´, ëª¨ë“  ì„¤ì •ì´ ì™„ë£Œëœ ê²ƒì…ë‹ˆë‹¤.

5. ìë™í™” ë° ìœ ì§€ë³´ìˆ˜
5.1. ìë™ ì¬ì‹œì‘
docker-compose.ymlì—ì„œ restart: always ì˜µì…˜ì„ ì„¤ì •í•˜ì—¬, ì„œë²„ê°€ ì¬ì‹œì‘ë˜ê±°ë‚˜ ì¥ì• ê°€ ë°œìƒí•´ë„ ìë™ìœ¼ë¡œ ë³µêµ¬ë©ë‹ˆë‹¤.

5.2. Certbot ì¸ì¦ì„œ ìë™ ê°±ì‹ 
Certbotì€ ìë™ìœ¼ë¡œ ì¸ì¦ì„œë¥¼ ê°±ì‹ í•˜ì§€ë§Œ, ë§Œì•½ ìˆ˜ë™ìœ¼ë¡œ ê°±ì‹ í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

bash
ë³µì‚¬
sudo certbot renew --quiet
ì´ë¥¼ cronjobìœ¼ë¡œ ìë™í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ì´ ë¦¬ë“œë¯¸ëŠ” nginx + Docker + FastAPI í™˜ê²½ì—ì„œ ë°°í¬í•˜ëŠ” ë° í•„ìš”í•œ ëª¨ë“  ë‹¨ê³„ë¥¼ ë‹¤ë£¨ê³  ìˆìŠµë‹ˆë‹¤.
ë”°ë¼ì„œ WhisperTextAnalyzer ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì •ìƒì ìœ¼ë¡œ ë°°í¬í•˜ê³ , ì¸ì¦ì„œë¥¼ ì„¤ì •í•˜ê³ , ì„œë¹„ìŠ¤ë¥¼ ìš´ì˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

````

# WhisperTextAnalyzer nginx ì„¤ì • ì™„ì„±íŒ
````
# HTTP â†’ HTTPS ë¦¬ë””ë ‰ì…˜ (í•„ìˆ˜)
server {
    listen 80;
    listen [::]:80;
    server_name whisperproject.duckdns.org;

    return 301 https://$host$request_uri;
}

# HTTPS + FastAPI + WebSocket í”„ë¡ì‹œ
server {
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name ë„ë©”ì¸ì´ë¦„;

    # â¡ï¸ certbot ë˜ëŠ” ì§ì ‘ ë°›ì€ ì¸ì¦ì„œ ê²½ë¡œ
    ssl_certificate /ì¸ì¦ì„œ ê²½ë¡œ/fullchain.pem;
    ssl_certificate_key /ì¸ì¦ì„œ ê²½ë¡œ/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;

    # -----------------------
    # ì¼ë°˜ HTTP â†’ FastAPI
    # -----------------------
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        client_max_body_size 100M;
        proxy_buffer_size 512k;
        proxy_buffers 4 512k;
        proxy_busy_buffers_size 512k;
        proxy_read_timeout 3600s;
    }

    # -----------------------
    # WebSocket â†’ FastAPI
    # -----------------------
    location /ws {
        proxy_pass http://127.0.0.1:8000/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;

        proxy_buffer_size 512k;
        proxy_buffers 4 512k;
        proxy_busy_buffers_size 512k;
        proxy_read_timeout 3600s;
    }

    # /ws/ path ëŒ€ì‘
    location /ws/ {
        proxy_pass http://127.0.0.1:8000/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;

        proxy_buffer_size 512k;
        proxy_buffers 4 512k;
        proxy_busy_buffers_size 512k;
        proxy_read_timeout 3600s;
    }
}
````



````
## ğŸ–¼ï¸ ìµœì¢… í”„ë¡œì íŠ¸ ë°°í¬ êµ¬ì¡°
>âœ… ê¸°ì¤€: 2024-05-14 ìµœì¢… í”„ë¡œì íŠ¸ êµ¬ì¡° ê¸°ì¤€  
>âœ… ì´ êµ¬ì¡°ëŠ” Docker + Celery + FastAPI + Redis + Listener + Recorder + Analyzer ì„œë¹„ìŠ¤ ë¶„ë¦¬ êµ¬ì¡°ì…ë‹ˆë‹¤.  
>âœ… ê° ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ì¸ Dockerfile + requirements.txtë¥¼ ê°€ì§‘ë‹ˆë‹¤.  
>âœ… ê°œë°œ ì¤‘ `record_service`ëŠ” ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©ìœ¼ë¡œ ì‚¬ìš©í–ˆìœ¼ë‚˜, ìµœì¢… ë°°í¬ì—ì„œëŠ” ì œì™¸
```plaintext
WhisperTextAnalyzer/
â”œâ”€â”€ analyzer_worker/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ analyze_worker.py
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ fastapi_service/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ fastapi_service.py
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ listener_service/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ listener_service.py
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ recorder_service/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ recorder_service.py
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ stt_worker/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ requirements.txt
â”‚   â””â”€â”€ sst_worker.py
â”œâ”€â”€ venv/ (ê°€ìƒí™˜ê²½ í´ë”)
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ .gitignore
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ README.md
â””â”€â”€ requirements.txt (root requirements íŒŒì¼)
```
---

## âœ¨ ìµœì¢… ì†Œê°
- ì•„ì§ ì™„ë²½í•œ MSAëŠ” ì•„ë‹ˆì§€ë§Œ, MSA ëŠë‚Œìœ¼ë¡œ ì»¨í…Œì´ë„ˆ/ì„œë¹„ìŠ¤ ë¶„ë¦¬ë¥¼ ì‹œë„í–ˆë‹¤.
- **Python í™˜ê²½ (Windows vs Linux)** ì°¨ì´ë¥¼ ì§ì ‘ ê²½í—˜í•˜ë©° ë°°ì› ìŒ
- ì‹¤ì‹œê°„ WebSocket ì˜¤ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì²˜ë¦¬ì˜ ì–´ë ¤ì›€ì„ ì²´í—˜
- Whisper ëª¨ë¸ì´ ê¸°ëŒ€í•˜ëŠ” ì˜¤ë””ì˜¤ í¬ë§·(WAV, 16kHz, mono)ì„ ë§ì¶”ëŠ” ê²Œ ì–¼ë§ˆë‚˜ ê¹Œë‹¤ë¡œìš´ì§€ ì´í•´
- ì‹¤ì„œë¹„ìŠ¤ ë°°í¬ê¹Œì§€ ì§ì ‘ ë‹¤ë£¨ë©´ì„œ **Docker, Redis, Celery, Web Audio API** ì „ì²´ ìŠ¤íƒ ê²½í—˜ ì™„ë£Œ
- ngrokì„ í†µí•œ ê°„í¸ í…ŒìŠ¤íŠ¸ ê¸°ë²•ì„ ì‹¤ë¬´ì—ì„œ ìµí˜

---

# ğŸ“¢ ì£¼ì˜ì‚¬í•­
- ë³¸ í”„ë¡œì íŠ¸ëŠ” í•™ìŠµ ë° ë°ëª¨ìš©ì´ë©°, ì‹¤ì œ ìƒìš© ì„œë¹„ìŠ¤ ë°°í¬ ì‹œ HTTPS/ì¸ì¦/ë³´ì•ˆ ì„¤ì •ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.
